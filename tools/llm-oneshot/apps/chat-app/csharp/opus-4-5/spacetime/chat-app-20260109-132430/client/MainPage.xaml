<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="ChatClient.MainPage"
             BackgroundColor="{StaticResource SpaceBackground}">
    
    <Grid ColumnDefinitions="280,*" RowDefinitions="*">
        <!-- SIDEBAR - Rooms List -->
        <Border Grid.Column="0"
                BackgroundColor="{StaticResource SpaceBackgroundLight}"
                StrokeThickness="0">
            <Grid RowDefinitions="Auto,Auto,*,Auto">
                <!-- User Profile Header -->
                <Border Grid.Row="0" 
                        BackgroundColor="{StaticResource SpaceBackgroundLighter}"
                        Padding="16"
                        StrokeThickness="0">
                    <Grid RowDefinitions="Auto,Auto,Auto" ColumnDefinitions="*,Auto">
                        <Label x:Name="LblDisplayName"
                               Text="Connecting..."
                               TextColor="{StaticResource TextPrimary}"
                               FontSize="18"
                               FontAttributes="Bold" />
                        <Label Grid.Row="1"
                               x:Name="LblStatus"
                               Text="â—  Offline"
                               TextColor="{StaticResource OfflineColor}"
                               FontSize="12" />
                        <Button Grid.Column="1"
                                Grid.RowSpan="2"
                                Text="âœï¸"
                                WidthRequest="40"
                                HeightRequest="40"
                                CornerRadius="20"
                                BackgroundColor="{StaticResource SpaceBackground}"
                                Clicked="OnEditDisplayName" />
                        
                        <!-- Display Name Edit -->
                        <HorizontalStackLayout Grid.Row="2" Grid.ColumnSpan="2"
                                               x:Name="DisplayNameEditor"
                                               IsVisible="False"
                                               Spacing="8"
                                               Margin="0,8,0,0">
                            <Entry x:Name="EntryDisplayName"
                                   Placeholder="Enter name..."
                                   WidthRequest="160"
                                   BackgroundColor="{StaticResource SpaceBackground}"
                                   TextColor="{StaticResource TextPrimary}"
                                   PlaceholderColor="{StaticResource TextMuted}" />
                            <Button Text="âœ“"
                                    WidthRequest="40"
                                    HeightRequest="40"
                                    BackgroundColor="{StaticResource SuccessColor}"
                                    TextColor="White"
                                    CornerRadius="8"
                                    Clicked="OnSaveDisplayName" />
                        </HorizontalStackLayout>
                    </Grid>
                </Border>
                
                <!-- Create Room -->
                <Border Grid.Row="1"
                        Padding="12"
                        BackgroundColor="Transparent"
                        StrokeThickness="0">
                    <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto">
                        <Label Text="ROOMS"
                               TextColor="{StaticResource TextMuted}"
                               FontSize="12"
                               FontAttributes="Bold"
                               VerticalOptions="Center" />
                        <Button Grid.Column="1"
                                Text="+"
                                WidthRequest="32"
                                HeightRequest="32"
                                CornerRadius="16"
                                BackgroundColor="{StaticResource StdbGreen}"
                                TextColor="White"
                                FontSize="18"
                                Clicked="OnCreateRoomToggle" />
                        
                        <!-- New Room Input -->
                        <HorizontalStackLayout Grid.Row="1" Grid.ColumnSpan="2"
                                               x:Name="NewRoomEditor"
                                               IsVisible="False"
                                               Spacing="8"
                                               Margin="0,8,0,0">
                            <Entry x:Name="EntryNewRoom"
                                   Placeholder="Room name..."
                                   WidthRequest="180"
                                   BackgroundColor="{StaticResource SpaceBackground}"
                                   TextColor="{StaticResource TextPrimary}"
                                   PlaceholderColor="{StaticResource TextMuted}" />
                            <Button Text="Create"
                                    WidthRequest="60"
                                    HeightRequest="40"
                                    BackgroundColor="{StaticResource StdbGreen}"
                                    TextColor="White"
                                    CornerRadius="8"
                                    Clicked="OnCreateRoom" />
                        </HorizontalStackLayout>
                    </Grid>
                </Border>
                
                <!-- Rooms List -->
                <ScrollView Grid.Row="2">
                    <VerticalStackLayout x:Name="RoomsList"
                                         Spacing="4"
                                         Padding="8" />
                </ScrollView>
                
                <!-- Online Users -->
                <Border Grid.Row="3"
                        BackgroundColor="{StaticResource SpaceBackgroundLighter}"
                        Padding="12"
                        StrokeThickness="0">
                    <Grid RowDefinitions="Auto,*">
                        <Label Text="ONLINE"
                               TextColor="{StaticResource TextMuted}"
                               FontSize="12"
                               FontAttributes="Bold" />
                        <ScrollView Grid.Row="1" HeightRequest="100">
                            <VerticalStackLayout x:Name="OnlineUsersList"
                                                 Spacing="4"
                                                 Margin="0,8,0,0" />
                        </ScrollView>
                    </Grid>
                </Border>
            </Grid>
        </Border>
        
        <!-- MAIN CHAT AREA -->
        <Grid Grid.Column="1" RowDefinitions="Auto,*,Auto,Auto">
            <!-- Room Header -->
            <Border Grid.Row="0"
                    BackgroundColor="{StaticResource SpaceBackgroundLight}"
                    Padding="16"
                    StrokeThickness="0">
                <Grid ColumnDefinitions="*,Auto,Auto">
                    <VerticalStackLayout>
                        <Label x:Name="LblRoomName"
                               Text="Select a room"
                               TextColor="{StaticResource TextPrimary}"
                               FontSize="20"
                               FontAttributes="Bold" />
                        <Label x:Name="LblRoomMembers"
                               Text=""
                               TextColor="{StaticResource TextSecondary}"
                               FontSize="12" />
                    </VerticalStackLayout>
                    <Button Grid.Column="1"
                            x:Name="BtnScheduleMessage"
                            Text="â°"
                            WidthRequest="40"
                            HeightRequest="40"
                            CornerRadius="20"
                            BackgroundColor="{StaticResource SpaceBackground}"
                            Margin="8,0"
                            IsVisible="False"
                            Clicked="OnScheduleMessageToggle" />
                    <Button Grid.Column="2"
                            x:Name="BtnLeaveRoom"
                            Text="Leave"
                            HeightRequest="40"
                            BackgroundColor="{StaticResource ErrorColor}"
                            TextColor="White"
                            CornerRadius="8"
                            IsVisible="False"
                            Clicked="OnLeaveRoom" />
                </Grid>
            </Border>
            
            <!-- Messages Area -->
            <ScrollView Grid.Row="1"
                        x:Name="MessagesScrollView"
                        BackgroundColor="{StaticResource SpaceBackground}">
                <VerticalStackLayout x:Name="MessagesList"
                                     Spacing="8"
                                     Padding="16">
                    <!-- Empty state shown when no room selected -->
                    <Label x:Name="LblEmptyState"
                           Text="Select a room to start chatting"
                           TextColor="{StaticResource TextMuted}"
                           FontSize="16"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"
                           Margin="0,100,0,0" />
                </VerticalStackLayout>
            </ScrollView>
            
            <!-- Typing Indicator -->
            <Border Grid.Row="2"
                    x:Name="TypingIndicatorArea"
                    BackgroundColor="Transparent"
                    Padding="16,4"
                    IsVisible="False"
                    StrokeThickness="0">
                <Label x:Name="LblTypingIndicator"
                       Text=""
                       TextColor="{StaticResource StdbGreen}"
                       FontSize="12"
                       FontAttributes="Italic" />
            </Border>
            
            <!-- Message Input Area -->
            <Border Grid.Row="3"
                    BackgroundColor="{StaticResource SpaceBackgroundLight}"
                    Padding="16"
                    StrokeThickness="0">
                <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="Auto,*,Auto,Auto">
                    <!-- Ephemeral Toggle -->
                    <Button x:Name="BtnEphemeral"
                            Text="ðŸ’¨"
                            WidthRequest="44"
                            HeightRequest="44"
                            CornerRadius="22"
                            BackgroundColor="{StaticResource SpaceBackground}"
                            BorderColor="{StaticResource BorderColor}"
                            BorderWidth="1"
                            Clicked="OnToggleEphemeral" />
                    
                    <!-- Message Entry -->
                    <Entry Grid.Column="1"
                           x:Name="EntryMessage"
                           Placeholder="Type a message..."
                           BackgroundColor="{StaticResource SpaceBackground}"
                           TextColor="{StaticResource TextPrimary}"
                           PlaceholderColor="{StaticResource TextMuted}"
                           Margin="8,0"
                           HeightRequest="44"
                           TextChanged="OnMessageTextChanged"
                           Completed="OnSendMessage" />
                    
                    <!-- Ephemeral Duration -->
                    <Picker Grid.Column="2"
                            x:Name="PickerEphemeralDuration"
                            IsVisible="False"
                            WidthRequest="80"
                            BackgroundColor="{StaticResource SpaceBackground}"
                            TextColor="{StaticResource TextPrimary}"
                            Margin="0,0,8,0">
                        <Picker.ItemsSource>
                            <x:Array Type="{x:Type x:String}">
                                <x:String>30s</x:String>
                                <x:String>1m</x:String>
                                <x:String>5m</x:String>
                                <x:String>10m</x:String>
                            </x:Array>
                        </Picker.ItemsSource>
                    </Picker>
                    
                    <!-- Send Button -->
                    <Button Grid.Column="3"
                            x:Name="BtnSend"
                            Text="Send"
                            WidthRequest="80"
                            HeightRequest="44"
                            BackgroundColor="{StaticResource StdbGreen}"
                            TextColor="White"
                            CornerRadius="8"
                            FontAttributes="Bold"
                            Clicked="OnSendMessage" />
                    
                    <!-- Schedule Message Panel (hidden by default) -->
                    <Border Grid.Row="1" Grid.ColumnSpan="4"
                            x:Name="ScheduleMessagePanel"
                            IsVisible="False"
                            BackgroundColor="{StaticResource SpaceBackgroundLighter}"
                            Padding="12"
                            Margin="0,12,0,0"
                            StrokeThickness="1"
                            Stroke="{StaticResource BorderColor}">
                        <Grid ColumnDefinitions="*,Auto,Auto,Auto,Auto" RowDefinitions="Auto,Auto">
                            <Label Text="Schedule Message"
                                   TextColor="{StaticResource StdbGreen}"
                                   FontAttributes="Bold"
                                   VerticalOptions="Center" />
                            <Button Grid.Column="4"
                                    Text="View Pending"
                                    BackgroundColor="Transparent"
                                    TextColor="{StaticResource TextMuted}"
                                    FontSize="12"
                                    Clicked="OnViewScheduledMessages" />
                            <DatePicker Grid.Row="1"
                                        x:Name="ScheduleDatePicker"
                                        BackgroundColor="{StaticResource SpaceBackground}"
                                        TextColor="{StaticResource TextPrimary}" />
                            <TimePicker Grid.Row="1" Grid.Column="1"
                                        x:Name="ScheduleTimePicker"
                                        BackgroundColor="{StaticResource SpaceBackground}"
                                        TextColor="{StaticResource TextPrimary}"
                                        Margin="8,0" />
                            <Button Grid.Row="1" Grid.Column="2"
                                    Text="Schedule"
                                    BackgroundColor="{StaticResource StdbGreen}"
                                    TextColor="{StaticResource SpaceBackground}"
                                    CornerRadius="8"
                                    Clicked="OnScheduleMessage" />
                            <Button Grid.Row="1" Grid.Column="3"
                                    Text="âœ•"
                                    WidthRequest="40"
                                    BackgroundColor="Transparent"
                                    TextColor="{StaticResource TextMuted}"
                                    Clicked="OnCancelSchedulePanel" />
                        </Grid>
                    </Border>
                </Grid>
            </Border>
        </Grid>
        
        <!-- Edit Message Overlay -->
        <Border Grid.ColumnSpan="2"
                x:Name="EditMessageOverlay"
                IsVisible="False"
                BackgroundColor="#CC000000"
                Padding="32">
            <Border BackgroundColor="{StaticResource SpaceBackgroundLight}"
                    Padding="24"
                    StrokeThickness="1"
                    Stroke="{StaticResource BorderColor}"
                    WidthRequest="500"
                    HorizontalOptions="Center"
                    VerticalOptions="Center">
                <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto">
                    <Label Text="Edit Message"
                           TextColor="{StaticResource TextPrimary}"
                           FontSize="20"
                           FontAttributes="Bold" />
                    <Editor Grid.Row="1"
                            x:Name="EditorEditMessage"
                            HeightRequest="100"
                            BackgroundColor="{StaticResource SpaceBackground}"
                            TextColor="{StaticResource TextPrimary}"
                            Margin="0,16,0,0" />
                    <HorizontalStackLayout Grid.Row="2" Spacing="12" Margin="0,16,0,0">
                        <Button Text="Save"
                                BackgroundColor="{StaticResource StdbGreen}"
                                TextColor="White"
                                CornerRadius="8"
                                WidthRequest="100"
                                Clicked="OnSaveEdit" />
                        <Button Text="Cancel"
                                BackgroundColor="{StaticResource SpaceBackground}"
                                TextColor="{StaticResource TextPrimary}"
                                BorderColor="{StaticResource BorderColor}"
                                BorderWidth="1"
                                CornerRadius="8"
                                WidthRequest="100"
                                Clicked="OnCancelEdit" />
                    </HorizontalStackLayout>
                    
                    <!-- Edit History -->
                    <Label Grid.Row="3"
                           Text="Edit History"
                           TextColor="{StaticResource TextSecondary}"
                           FontSize="14"
                           FontAttributes="Bold"
                           Margin="0,24,0,8" />
                    <ScrollView Grid.Row="4" HeightRequest="150">
                        <VerticalStackLayout x:Name="EditHistoryList"
                                             Spacing="8" />
                    </ScrollView>
                </Grid>
            </Border>
        </Border>
        
        <!-- Scheduled Messages Overlay -->
        <Border Grid.ColumnSpan="2"
                x:Name="ScheduledMessagesOverlay"
                IsVisible="False"
                BackgroundColor="#CC000000"
                Padding="32">
            <Border BackgroundColor="{StaticResource SpaceBackgroundLight}"
                    Padding="24"
                    StrokeThickness="1"
                    Stroke="{StaticResource BorderColor}"
                    WidthRequest="500"
                    HorizontalOptions="Center"
                    VerticalOptions="Center">
                <Grid RowDefinitions="Auto,*,Auto">
                    <Label Text="Scheduled Messages"
                           TextColor="{StaticResource StdbGreen}"
                           FontSize="20"
                           FontAttributes="Bold" />
                    <ScrollView Grid.Row="1" HeightRequest="300" Margin="0,16,0,0">
                        <VerticalStackLayout x:Name="ScheduledMessagesList"
                                             Spacing="8" />
                    </ScrollView>
                    <Button Grid.Row="2"
                            Text="Close"
                            BackgroundColor="{StaticResource SpaceBackground}"
                            TextColor="{StaticResource TextPrimary}"
                            BorderColor="{StaticResource BorderColor}"
                            BorderWidth="1"
                            CornerRadius="8"
                            HorizontalOptions="End"
                            Margin="0,16,0,0"
                            Clicked="OnCloseScheduledMessages" />
                </Grid>
            </Border>
        </Border>
        
        <!-- Reaction Picker Overlay -->
        <Border Grid.ColumnSpan="2"
                x:Name="ReactionPickerOverlay"
                IsVisible="False"
                BackgroundColor="#66000000"
                InputTransparent="False">
            <Border.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnCloseReactionPicker" />
            </Border.GestureRecognizers>
            <Border BackgroundColor="{StaticResource SpaceBackgroundLighter}"
                    Padding="16"
                    StrokeThickness="1"
                    Stroke="{StaticResource BorderColor}"
                    WidthRequest="280"
                    HeightRequest="60"
                    HorizontalOptions="Center"
                    VerticalOptions="Center"
                    InputTransparent="False">
                <HorizontalStackLayout Spacing="12" HorizontalOptions="Center">
                    <Button Text="ðŸ‘" FontSize="24" BackgroundColor="Transparent" Clicked="OnReactionSelected" />
                    <Button Text="â¤ï¸" FontSize="24" BackgroundColor="Transparent" Clicked="OnReactionSelected" />
                    <Button Text="ðŸ˜‚" FontSize="24" BackgroundColor="Transparent" Clicked="OnReactionSelected" />
                    <Button Text="ðŸ˜®" FontSize="24" BackgroundColor="Transparent" Clicked="OnReactionSelected" />
                    <Button Text="ðŸ˜¢" FontSize="24" BackgroundColor="Transparent" Clicked="OnReactionSelected" />
                </HorizontalStackLayout>
            </Border>
        </Border>
    </Grid>
</ContentPage>
