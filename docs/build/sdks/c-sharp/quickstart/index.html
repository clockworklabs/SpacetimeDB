<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Client SDK Languages/CSharp-Quickstart" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.1">
<title data-rh="true">C# Quickstart | SpacetimeDB docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.spacetimedb.com/sdks/c-sharp/quickstart"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="C# Quickstart | SpacetimeDB docs"><meta data-rh="true" name="description" content="Client SDK Quick Start"><meta data-rh="true" property="og:description" content="Client SDK Quick Start"><link data-rh="true" rel="icon" href="/images/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.spacetimedb.com/sdks/c-sharp/quickstart"><link data-rh="true" rel="alternate" href="https://docs.spacetimedb.com/sdks/c-sharp/quickstart" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.spacetimedb.com/sdks/c-sharp/quickstart" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://QBC7Z9KXS2-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"C# Quickstart","item":"https://docs.spacetimedb.com/sdks/c-sharp/quickstart"}]}</script><link rel="search" type="application/opensearchdescription+xml" title="SpacetimeDB docs" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.0cb9f7a7.css">
<script src="/assets/js/runtime~main.d71df0f5.js" defer="defer"></script>
<script src="/assets/js/main.31d95d83.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>document.documentElement.setAttribute("data-theme","light"),document.documentElement.setAttribute("data-theme-choice","light"),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="https://spacetimedb.com/images/brand.png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_6jFv" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="https://spacetimedb.com/images/brand.png" alt="SpacetimeDB Logo" class="themedComponent_rvet themedComponent--light_mbAJ"><img src="https://spacetimedb.com/images/brand.png" alt="SpacetimeDB Logo" class="themedComponent_rvet themedComponent--dark_Ncy6"></div></a><div class="navbarSearchContainer_AesG"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://spacetimedb.com/install" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Install</a><a href="https://spacetimedb.com/pricing" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Pricing</a><a href="https://spacetimedb.com/maincloud" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Maincloud</a><a href="https://spacetimedb.com/blog" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Blog</a><a href="https://spacetimedb.com/community" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Community</a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_hV_y"><div class="docsWrapper_f07g"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_MJiz" type="button"></button><div class="docRoot_Gd2s"><aside class="theme-doc-sidebar-container docSidebarContainer_fSpF"><div class="sidebarViewport_YElg"><div class="sidebar_kjg4"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_AG0n"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/"><span title="Intro" class="categoryLinkLabel_EDYQ">Intro</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/deploying/maincloud"><span title="Deploying" class="categoryLinkLabel_EDYQ">Deploying</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/unity"><span title="Unity tutorial" class="categoryLinkLabel_EDYQ">Unity tutorial</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/unreal"><span title="Unreal Tutorial" class="categoryLinkLabel_EDYQ">Unreal Tutorial</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/cli-reference"><span title="CLI Reference" class="categoryLinkLabel_EDYQ">CLI Reference</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/modules"><span title="Server Module Languages" class="categoryLinkLabel_EDYQ">Server Module Languages</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/sdks"><span title="Client SDK Languages" class="categoryLinkLabel_EDYQ">Client SDK Languages</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/sdks"><span title="Overview" class="linkLabel_dpMB">Overview</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/sdks/c-sharp/quickstart"><span title="C# Quickstart" class="linkLabel_dpMB">C# Quickstart</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/sdks/c-sharp"><span title="C# Reference" class="linkLabel_dpMB">C# Reference</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/sdks/rust/quickstart"><span title="Rust Quickstart" class="linkLabel_dpMB">Rust Quickstart</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/sdks/rust"><span title="Rust Reference" class="linkLabel_dpMB">Rust Reference</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/sdks/typescript/quickstart"><span title="TypeScript Quickstart" class="linkLabel_dpMB">TypeScript Quickstart</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/sdks/typescript"><span title="TypeScript Reference" class="linkLabel_dpMB">TypeScript Reference</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/sql"><span title="SQL" class="categoryLinkLabel_EDYQ">SQL</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/subscriptions"><span title="Subscriptions" class="categoryLinkLabel_EDYQ">Subscriptions</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/rls"><span title="Row Level Security" class="linkLabel_dpMB">Row Level Security</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/how-to/incremental-migrations"><span title="How-To" class="categoryLinkLabel_EDYQ">How-To</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/spacetimeauth"><span title="SpacetimeAuth" class="categoryLinkLabel_EDYQ">SpacetimeAuth</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/http/authorization"><span title="HTTP API" class="categoryLinkLabel_EDYQ">HTTP API</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/webassembly-abi"><span title="Internals" class="categoryLinkLabel_EDYQ">Internals</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/appendix"><span title="Appendix" class="linkLabel_dpMB">Appendix</span></a></li></ul></nav></div></div></aside><main class="docMainContainer_dkUT"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_w2oE"><div class="docItemContainer_f71m"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_xsLZ" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_oyay"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Client SDK Languages</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">C# Quickstart</span></li></ul></nav><div class="tocCollapsible_dqme theme-doc-toc-mobile tocMobile_Z34P"><button type="button" class="clean-btn tocCollapsibleButton_QMSE">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>C# Client SDK Quick Start</h1></header>
<p>In this guide we&#x27;ll show you how to get up and running with a simple SpacetimeDB app with a client written in C#.</p>
<p>We&#x27;ll implement a command-line client for the module created in our <a href="/modules/rust/quickstart">Rust</a> or <a href="/modules/c-sharp/quickstart">C# Module</a> Quickstart guides. Ensure you followed one of these guides before continuing.</p>
<h2 class="anchor anchorWithStickyNavbar_wKCU" id="project-structure">Project structure<a href="#project-structure" class="hash-link" aria-label="Direct link to Project structure" title="Direct link to Project structure" translate="no">​</a></h2>
<p>Enter the directory <code>quickstart-chat</code> you created in the <a href="/modules/rust/quickstart">Rust Module Quickstart</a> or <a href="/modules/c-sharp/quickstart">C# Module Quickstart</a> guides:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#8BE9FD">cd</span><span style="color:#F1FA8C"> quickstart-chat</span></span></code></pre>
<p>Within it, create a new C# console application project called <code>client</code> using either Visual Studio, Rider or the .NET CLI:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#50FA7B">dotnet</span><span style="color:#F1FA8C"> new</span><span style="color:#F1FA8C"> console</span><span style="color:#BD93F9"> -o</span><span style="color:#F1FA8C"> client</span></span></code></pre>
<p>Open the project in your IDE of choice.</p>
<h2 class="anchor anchorWithStickyNavbar_wKCU" id="add-the-nuget-package-for-the-c-spacetimedb-sdk">Add the NuGet package for the C# SpacetimeDB SDK<a href="#add-the-nuget-package-for-the-c-spacetimedb-sdk" class="hash-link" aria-label="Direct link to Add the NuGet package for the C# SpacetimeDB SDK" title="Direct link to Add the NuGet package for the C# SpacetimeDB SDK" translate="no">​</a></h2>
<p>Add the <code>SpacetimeDB.ClientSDK</code> <a href="https://www.nuget.org/packages/SpacetimeDB.ClientSDK/" target="_blank" rel="noopener noreferrer">NuGet package</a> using Visual Studio or Rider <em>NuGet Package Manager</em> or via the .NET CLI:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#50FA7B">dotnet</span><span style="color:#F1FA8C"> add</span><span style="color:#F1FA8C"> package</span><span style="color:#F1FA8C"> SpacetimeDB.ClientSDK</span></span></code></pre>
<h2 class="anchor anchorWithStickyNavbar_wKCU" id="clear-clientprogramcs">Clear <code>client/Program.cs</code><a href="#clear-clientprogramcs" class="hash-link" aria-label="Direct link to clear-clientprogramcs" title="Direct link to clear-clientprogramcs" translate="no">​</a></h2>
<p>Clear out any data from <code>client/Program.cs</code> so we can write our chat client.</p>
<h2 class="anchor anchorWithStickyNavbar_wKCU" id="generate-your-module-types">Generate your module types<a href="#generate-your-module-types" class="hash-link" aria-label="Direct link to Generate your module types" title="Direct link to Generate your module types" translate="no">​</a></h2>
<p>The <code>spacetime</code> CLI&#x27;s <code>generate</code> command will generate client-side interfaces for the tables, reducers and types defined in your server module.</p>
<p>In your <code>quickstart-chat</code> directory, run:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#50FA7B">mkdir</span><span style="color:#BD93F9"> -p</span><span style="color:#F1FA8C"> client/module_bindings</span></span>
<span class="line"><span style="color:#50FA7B">spacetime</span><span style="color:#F1FA8C"> generate</span><span style="color:#BD93F9"> --lang</span><span style="color:#F1FA8C"> csharp</span><span style="color:#BD93F9"> --out-dir</span><span style="color:#F1FA8C"> client/module_bindings</span><span style="color:#BD93F9"> --project-path</span><span style="color:#F1FA8C"> server</span></span></code></pre>
<p>Take a look inside <code>client/module_bindings</code>. The CLI should have generated three folders and nine files:</p>
<div class="language-text codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_p1l2"><pre tabindex="0" class="prism-code language-text codeBlock_qbrE thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="token-line" style="color:#bfc7d5"><span class="token plain">module_bindings</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">├── Reducers</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">│   ├── ClientConnected.g.cs</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">│   ├── ClientDisconnected.g.cs</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">│   ├── SendMessage.g.cs</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">│   └── SetName.g.cs</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">├── Tables</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">│   ├── Message.g.cs</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">│   └── User.g.cs</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">├── Types</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">│   ├── Message.g.cs</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">│   └── User.g.cs</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">└── SpacetimeDBClient.g.cs</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_wKCU" id="add-imports-to-programcs">Add imports to Program.cs<a href="#add-imports-to-programcs" class="hash-link" aria-label="Direct link to Add imports to Program.cs" title="Direct link to Add imports to Program.cs" translate="no">​</a></h2>
<p>Open <code>client/Program.cs</code> and add the following imports:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#FF79C6">using</span><span style="color:#8BE9FD;font-style:italic"> SpacetimeDB</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#FF79C6">using</span><span style="color:#8BE9FD;font-style:italic"> SpacetimeDB</span><span style="color:#F8F8F2">.</span><span style="color:#8BE9FD;font-style:italic">Types</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#FF79C6">using</span><span style="color:#8BE9FD;font-style:italic"> System</span><span style="color:#F8F8F2">.</span><span style="color:#8BE9FD;font-style:italic">Collections</span><span style="color:#F8F8F2">.</span><span style="color:#8BE9FD;font-style:italic">Concurrent</span><span style="color:#F8F8F2">;</span></span></code></pre>
<p>We will also need to create some global variables. We&#x27;ll cover the <code>Identity</code> later in the <code>Save credentials</code> section. Later we&#x27;ll also be setting up a second thread for handling user input. In the <code>Process thread</code> section we&#x27;ll use this in the <code>ConcurrentQueue</code> to store the commands for that thread.</p>
<p>To <code>Program.cs</code>, add:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#6272A4">// our local client SpacetimeDB identity</span></span>
<span class="line"><span style="color:#8BE9FD;font-style:italic">Identity</span><span style="color:#F8F8F2">? local_identity </span><span style="color:#FF79C6">=</span><span style="color:#BD93F9"> null</span><span style="color:#F8F8F2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">// declare a thread safe queue to store commands</span></span>
<span class="line"><span style="color:#FF79C6">var</span><span style="color:#F8F8F2"> input_queue </span><span style="color:#FF79C6">=</span><span style="color:#FF79C6"> new</span><span style="color:#8BE9FD;font-style:italic"> ConcurrentQueue</span><span style="color:#F8F8F2">&lt;(</span><span style="color:#FF79C6">string</span><span style="color:#F8F8F2"> Command, </span><span style="color:#FF79C6">string</span><span style="color:#F8F8F2"> Args)&gt;();</span></span></code></pre>
<h2 class="anchor anchorWithStickyNavbar_wKCU" id="define-main-function">Define Main function<a href="#define-main-function" class="hash-link" aria-label="Direct link to Define Main function" title="Direct link to Define Main function" translate="no">​</a></h2>
<p>We&#x27;ll work outside-in, first defining our <code>Main</code> function at a high level, then implementing each behavior it needs. We need <code>Main</code> to do several things:</p>
<ol>
<li>Initialize the <code>AuthToken</code> module, which loads and stores our authentication token to/from local storage.</li>
<li>Connect to the database.</li>
<li>Register a number of callbacks to run in response to various database events.</li>
<li>Start our processing thread which connects to the SpacetimeDB database, updates the SpacetimeDB client and processes commands that come in from the input loop running in the main thread.</li>
<li>Start the input loop, which reads commands from standard input and sends them to the processing thread.</li>
<li>When the input loop exits, stop the processing thread and wait for it to exit.</li>
</ol>
<p>To <code>Program.cs</code>, add:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#FF79C6">void</span><span style="color:#50FA7B"> Main</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#F8F8F2">{</span></span>
<span class="line"><span style="color:#6272A4">    // Initialize the `AuthToken` module</span></span>
<span class="line"><span style="color:#F8F8F2">    AuthToken.</span><span style="color:#50FA7B">Init</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">.spacetime_csharp_quickstart</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#6272A4">    // Builds and connects to the database</span></span>
<span class="line"><span style="color:#8BE9FD;font-style:italic">    DbConnection</span><span style="color:#F8F8F2">? conn </span><span style="color:#FF79C6">=</span><span style="color:#BD93F9"> null</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#F8F8F2">    conn </span><span style="color:#FF79C6">=</span><span style="color:#50FA7B"> ConnectToDB</span><span style="color:#F8F8F2">();</span></span>
<span class="line"><span style="color:#6272A4">    // Registers to run in response to database events.</span></span>
<span class="line"><span style="color:#50FA7B">    RegisterCallbacks</span><span style="color:#F8F8F2">(conn);</span></span>
<span class="line"><span style="color:#6272A4">    // Declare a threadsafe cancel token to cancel the process loop</span></span>
<span class="line"><span style="color:#FF79C6">    var</span><span style="color:#F8F8F2"> cancellationTokenSource </span><span style="color:#FF79C6">=</span><span style="color:#FF79C6"> new</span><span style="color:#8BE9FD;font-style:italic"> CancellationTokenSource</span><span style="color:#F8F8F2">();</span></span>
<span class="line"><span style="color:#6272A4">    // Spawn a thread to call process updates and process commands</span></span>
<span class="line"><span style="color:#FF79C6">    var</span><span style="color:#F8F8F2"> thread </span><span style="color:#FF79C6">=</span><span style="color:#FF79C6"> new</span><span style="color:#8BE9FD;font-style:italic"> Thread</span><span style="color:#F8F8F2">(() </span><span style="color:#FF79C6">=&gt;</span><span style="color:#50FA7B"> ProcessThread</span><span style="color:#F8F8F2">(conn, cancellationTokenSource.Token));</span></span>
<span class="line"><span style="color:#F8F8F2">    thread.</span><span style="color:#50FA7B">Start</span><span style="color:#F8F8F2">();</span></span>
<span class="line"><span style="color:#6272A4">    // Handles CLI input</span></span>
<span class="line"><span style="color:#50FA7B">    InputLoop</span><span style="color:#F8F8F2">();</span></span>
<span class="line"><span style="color:#6272A4">    // This signals the ProcessThread to stop</span></span>
<span class="line"><span style="color:#F8F8F2">    cancellationTokenSource.</span><span style="color:#50FA7B">Cancel</span><span style="color:#F8F8F2">();</span></span>
<span class="line"><span style="color:#F8F8F2">    thread.</span><span style="color:#50FA7B">Join</span><span style="color:#F8F8F2">();</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<h2 class="anchor anchorWithStickyNavbar_wKCU" id="connect-to-database">Connect to database<a href="#connect-to-database" class="hash-link" aria-label="Direct link to Connect to database" title="Direct link to Connect to database" translate="no">​</a></h2>
<p>Before we connect, we&#x27;ll store the SpacetimeDB hostname and our database name in constants <code>HOST</code> and <code>DB_NAME</code>.</p>
<p>A connection to a SpacetimeDB database is represented by a <code>DbConnection</code>. We configure <code>DbConnection</code>s using the builder pattern, by calling <code>DbConnection.Builder()</code>, chaining method calls to set various connection parameters and register callbacks, then we cap it off with a call to <code>.Build()</code> to begin the connection.</p>
<p>In our case, we&#x27;ll supply the following options:</p>
<ol>
<li>A <code>WithUri</code> call, to specify the URI of the SpacetimeDB host where our database is running.</li>
<li>A <code>WithModuleName</code> call, to specify the name or <code>Identity</code> of our database. Make sure to pass the same name here as you supplied to <code>spacetime publish</code>.</li>
<li>A <code>WithToken</code> call, to supply a token to authenticate with.</li>
<li>An <code>OnConnect</code> callback, to run when the remote database acknowledges and accepts our connection.</li>
<li>An <code>OnConnectError</code> callback, to run if the remote database is unreachable or it rejects our connection.</li>
<li>An <code>OnDisconnect</code> callback, to run when our connection ends.</li>
</ol>
<p>To <code>Program.cs</code>, add:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#6272A4">/// The URI of the SpacetimeDB instance hosting our chat database and module.</span></span>
<span class="line"><span style="color:#FF79C6">const</span><span style="color:#FF79C6"> string</span><span style="color:#F8F8F2"> HOST </span><span style="color:#FF79C6">=</span><span style="color:#E9F284"> &quot;</span><span style="color:#F1FA8C">http://localhost:3000</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">/// The database name we chose when we published our module.</span></span>
<span class="line"><span style="color:#FF79C6">const</span><span style="color:#FF79C6"> string</span><span style="color:#F8F8F2"> DB_NAME </span><span style="color:#FF79C6">=</span><span style="color:#E9F284"> &quot;</span><span style="color:#F1FA8C">quickstart-chat</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">/// Load credentials from a file and connect to the database.</span></span>
<span class="line"><span style="color:#8BE9FD;font-style:italic">DbConnection</span><span style="color:#50FA7B"> ConnectToDB</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#F8F8F2">{</span></span>
<span class="line"><span style="color:#8BE9FD;font-style:italic">    DbConnection</span><span style="color:#F8F8F2">? conn </span><span style="color:#FF79C6">=</span><span style="color:#BD93F9"> null</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#F8F8F2">    conn </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> DbConnection.</span><span style="color:#50FA7B">Builder</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#F8F8F2">        .</span><span style="color:#50FA7B">WithUri</span><span style="color:#F8F8F2">(HOST)</span></span>
<span class="line"><span style="color:#F8F8F2">        .</span><span style="color:#50FA7B">WithModuleName</span><span style="color:#F8F8F2">(DB_NAME)</span></span>
<span class="line"><span style="color:#F8F8F2">        .</span><span style="color:#50FA7B">WithToken</span><span style="color:#F8F8F2">(AuthToken.Token)</span></span>
<span class="line"><span style="color:#F8F8F2">        .</span><span style="color:#50FA7B">OnConnect</span><span style="color:#F8F8F2">(OnConnected)</span></span>
<span class="line"><span style="color:#F8F8F2">        .</span><span style="color:#50FA7B">OnConnectError</span><span style="color:#F8F8F2">(OnConnectError)</span></span>
<span class="line"><span style="color:#F8F8F2">        .</span><span style="color:#50FA7B">OnDisconnect</span><span style="color:#F8F8F2">(OnDisconnected)</span></span>
<span class="line"><span style="color:#F8F8F2">        .</span><span style="color:#50FA7B">Build</span><span style="color:#F8F8F2">();</span></span>
<span class="line"><span style="color:#FF79C6">    return</span><span style="color:#F8F8F2"> conn;</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<h3 class="anchor anchorWithStickyNavbar_wKCU" id="save-credentials">Save credentials<a href="#save-credentials" class="hash-link" aria-label="Direct link to Save credentials" title="Direct link to Save credentials" translate="no">​</a></h3>
<p>SpacetimeDB will accept any <a href="https://openid.net/developers/how-connect-works/" target="_blank" rel="noopener noreferrer">OpenID Connect</a> compliant <a href="https://jwt.io/" target="_blank" rel="noopener noreferrer">JSON Web Token</a> and use it to compute an <code>Identity</code> for the user. More complex applications will generally authenticate their user somehow, generate or retrieve a token, and attach it to their connection via <code>WithToken</code>. In our case, though, we&#x27;ll connect anonymously the first time, let SpacetimeDB generate a fresh <code>Identity</code> and corresponding JWT for us, and save that token locally to re-use the next time we connect.</p>
<p>Once we are connected, we&#x27;ll use the <code>AuthToken</code> module to save our token to local storage, so that we can re-authenticate as the same user the next time we connect. We&#x27;ll also store the identity in a global variable <code>local_identity</code> so that we can use it to check if we are the sender of a message or name change. This callback also notifies us of our client&#x27;s <code>Address</code>, an opaque identifier SpacetimeDB modules can use to distinguish connections by the same <code>Identity</code>, but we won&#x27;t use it in our app.</p>
<p>To <code>Program.cs</code>, add:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#6272A4">/// Our `OnConnected` callback: save our credentials to a file.</span></span>
<span class="line"><span style="color:#FF79C6">void</span><span style="color:#50FA7B"> OnConnected</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD;font-style:italic">DbConnection</span><span style="color:#FFB86C;font-style:italic"> conn</span><span style="color:#F8F8F2">, </span><span style="color:#8BE9FD;font-style:italic">Identity</span><span style="color:#FFB86C;font-style:italic"> identity</span><span style="color:#F8F8F2">, </span><span style="color:#FF79C6">string</span><span style="color:#FFB86C;font-style:italic"> authToken</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">{</span></span>
<span class="line"><span style="color:#F8F8F2">    local_identity </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> identity;</span></span>
<span class="line"><span style="color:#F8F8F2">    AuthToken.</span><span style="color:#50FA7B">SaveToken</span><span style="color:#F8F8F2">(authToken);</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<h3 class="anchor anchorWithStickyNavbar_wKCU" id="connect-error-callback">Connect Error callback<a href="#connect-error-callback" class="hash-link" aria-label="Direct link to Connect Error callback" title="Direct link to Connect Error callback" translate="no">​</a></h3>
<p>Should we get an error during connection, we&#x27;ll be given an <code>Exception</code> which contains the details about the exception. To keep things simple, we&#x27;ll just write the exception to the console.</p>
<p>To <code>Program.cs</code>, add:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#6272A4">/// Our `OnConnectError` callback: print the error, then exit the process.</span></span>
<span class="line"><span style="color:#FF79C6">void</span><span style="color:#50FA7B"> OnConnectError</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD;font-style:italic">Exception</span><span style="color:#FFB86C;font-style:italic"> e</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">{</span></span>
<span class="line"><span style="color:#F8F8F2">    Console.</span><span style="color:#50FA7B">Write</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">$&quot;</span><span style="color:#F1FA8C">Error while connecting: </span><span style="color:#FF79C6">{</span><span style="color:#F8F8F2">e</span><span style="color:#FF79C6">}</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<h3 class="anchor anchorWithStickyNavbar_wKCU" id="disconnect-callback">Disconnect callback<a href="#disconnect-callback" class="hash-link" aria-label="Direct link to Disconnect callback" title="Direct link to Disconnect callback" translate="no">​</a></h3>
<p>When disconnecting, the callback contains the connection details and if an error occurs, it will also contain an <code>Exception</code>. If we get an error, we&#x27;ll write the error to the console, if not, we&#x27;ll just write that we disconnected.</p>
<p>To <code>Program.cs</code>, add:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#6272A4">/// Our `OnDisconnect` callback: print a note, then exit the process.</span></span>
<span class="line"><span style="color:#FF79C6">void</span><span style="color:#50FA7B"> OnDisconnected</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD;font-style:italic">DbConnection</span><span style="color:#FFB86C;font-style:italic"> conn</span><span style="color:#F8F8F2">, </span><span style="color:#8BE9FD;font-style:italic">Exception</span><span style="color:#F8F8F2">? </span><span style="color:#FFB86C;font-style:italic">e</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">{</span></span>
<span class="line"><span style="color:#FF79C6">    if</span><span style="color:#F8F8F2"> (e </span><span style="color:#FF79C6">!=</span><span style="color:#BD93F9"> null</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">    {</span></span>
<span class="line"><span style="color:#F8F8F2">        Console.</span><span style="color:#50FA7B">Write</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">$&quot;</span><span style="color:#F1FA8C">Disconnected abnormally: </span><span style="color:#FF79C6">{</span><span style="color:#F8F8F2">e</span><span style="color:#FF79C6">}</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#FF79C6">    else</span></span>
<span class="line"><span style="color:#F8F8F2">    {</span></span>
<span class="line"><span style="color:#F8F8F2">        Console.</span><span style="color:#50FA7B">Write</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">$&quot;</span><span style="color:#F1FA8C">Disconnected normally.</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<h2 class="anchor anchorWithStickyNavbar_wKCU" id="register-callbacks">Register callbacks<a href="#register-callbacks" class="hash-link" aria-label="Direct link to Register callbacks" title="Direct link to Register callbacks" translate="no">​</a></h2>
<p>Now we need to handle several sorts of events with Tables and Reducers:</p>
<ol>
<li><code>User.OnInsert</code>: When a new user joins, we&#x27;ll print a message introducing them.</li>
<li><code>User.OnUpdate</code>: When a user is updated, we&#x27;ll print their new name, or declare their new online status.</li>
<li><code>Message.OnInsert</code>: When we receive a new message, we&#x27;ll print it.</li>
<li><code>Reducer.OnSetName</code>: If the server rejects our attempt to set our name, we&#x27;ll print an error.</li>
<li><code>Reducer.OnSendMessage</code>: If the server rejects a message we send, we&#x27;ll print an error.</li>
</ol>
<p>To <code>Program.cs</code>, add:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#6272A4">/// Register all the callbacks our app will use to respond to database events.</span></span>
<span class="line"><span style="color:#FF79C6">void</span><span style="color:#50FA7B"> RegisterCallbacks</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD;font-style:italic">DbConnection</span><span style="color:#FFB86C;font-style:italic"> conn</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">{</span></span>
<span class="line"><span style="color:#F8F8F2">    conn.Db.User.OnInsert </span><span style="color:#FF79C6">+=</span><span style="color:#F8F8F2"> User_OnInsert;</span></span>
<span class="line"><span style="color:#F8F8F2">    conn.Db.User.OnUpdate </span><span style="color:#FF79C6">+=</span><span style="color:#F8F8F2"> User_OnUpdate;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">    conn.Db.Message.OnInsert </span><span style="color:#FF79C6">+=</span><span style="color:#F8F8F2"> Message_OnInsert;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">    conn.Reducers.OnSetName </span><span style="color:#FF79C6">+=</span><span style="color:#F8F8F2"> Reducer_OnSetNameEvent;</span></span>
<span class="line"><span style="color:#F8F8F2">    conn.Reducers.OnSendMessage </span><span style="color:#FF79C6">+=</span><span style="color:#F8F8F2"> Reducer_OnSendMessageEvent;</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<h3 class="anchor anchorWithStickyNavbar_wKCU" id="notify-about-new-users">Notify about new users<a href="#notify-about-new-users" class="hash-link" aria-label="Direct link to Notify about new users" title="Direct link to Notify about new users" translate="no">​</a></h3>
<p>For each table, we can register on-insert and on-delete callbacks to be run whenever a subscribed row is inserted or deleted. We register these callbacks using the <code>OnInsert</code> and <code>OnDelete</code> methods, which are automatically generated for each table by <code>spacetime generate</code>.</p>
<p>These callbacks can fire in two contexts:</p>
<ul>
<li>After a reducer runs, when the client&#x27;s cache is updated about changes to subscribed rows.</li>
<li>After calling <code>subscribe</code>, when the client&#x27;s cache is initialized with all existing matching rows.</li>
</ul>
<p>This second case means that, even though the module only ever inserts online users, the client&#x27;s <code>User.OnInsert</code> callbacks may be invoked with users who are offline. We&#x27;ll only notify about online users.</p>
<p><code>OnInsert</code> and <code>OnDelete</code> callbacks take two arguments: an <code>EventContext</code> and the altered row. The <code>EventContext.Event</code> is an enum which describes the event that caused the row to be inserted or deleted. All SpacetimeDB callbacks accept a context argument, which you can use in place of your top-level <code>DbConnection</code>.</p>
<p>Whenever we want to print a user, if they have set a name, we&#x27;ll use that. If they haven&#x27;t set a name, we&#x27;ll instead print the first 8 bytes of their identity, encoded as hexadecimal. We&#x27;ll define a function <code>UserNameOrIdentity</code> to handle this.</p>
<p>To <code>Program.cs</code>, add:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#6272A4">/// If the user has no set name, use the first 8 characters from their identity.</span></span>
<span class="line"><span style="color:#FF79C6">string</span><span style="color:#50FA7B"> UserNameOrIdentity</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD;font-style:italic">User</span><span style="color:#FFB86C;font-style:italic"> user</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">=&gt;</span><span style="color:#F8F8F2"> user.Name </span><span style="color:#FF79C6">??</span><span style="color:#F8F8F2"> user.Identity.</span><span style="color:#50FA7B">ToString</span><span style="color:#F8F8F2">()[</span><span style="color:#FF79C6">..</span><span style="color:#BD93F9">8</span><span style="color:#F8F8F2">];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">/// Our `User.OnInsert` callback: if the user is online, print a notification.</span></span>
<span class="line"><span style="color:#FF79C6">void</span><span style="color:#50FA7B"> User_OnInsert</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD;font-style:italic">EventContext</span><span style="color:#FFB86C;font-style:italic"> ctx</span><span style="color:#F8F8F2">, </span><span style="color:#8BE9FD;font-style:italic">User</span><span style="color:#FFB86C;font-style:italic"> insertedValue</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">{</span></span>
<span class="line"><span style="color:#FF79C6">    if</span><span style="color:#F8F8F2"> (insertedValue.Online)</span></span>
<span class="line"><span style="color:#F8F8F2">    {</span></span>
<span class="line"><span style="color:#F8F8F2">        Console.</span><span style="color:#50FA7B">WriteLine</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">$&quot;</span><span style="color:#FF79C6">{</span><span style="color:#50FA7B">UserNameOrIdentity</span><span style="color:#F1FA8C">(</span><span style="color:#F8F8F2">insertedValue</span><span style="color:#F1FA8C">)</span><span style="color:#FF79C6">}</span><span style="color:#F1FA8C"> is online</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<h3 class="anchor anchorWithStickyNavbar_wKCU" id="notify-about-updated-users">Notify about updated users<a href="#notify-about-updated-users" class="hash-link" aria-label="Direct link to Notify about updated users" title="Direct link to Notify about updated users" translate="no">​</a></h3>
<p>Because we declared a primary key column in our <code>User</code> table, we can also register on-update callbacks. These run whenever a row is replaced by a row with the same primary key, like our module&#x27;s <code>User.Identity.Update</code> calls. We register these callbacks using the <code>OnUpdate</code> method, which is automatically implemented by <code>spacetime generate</code> for any table with a primary key column.</p>
<p><code>OnUpdate</code> callbacks take three arguments: the old row, the new row, and a <code>EventContext</code>.</p>
<p>In our module, users can be updated for three reasons:</p>
<ol>
<li>They&#x27;ve set their name using the <code>SetName</code> reducer.</li>
<li>They&#x27;re an existing user re-connecting, so their <code>Online</code> has been set to <code>true</code>.</li>
<li>They&#x27;ve disconnected, so their <code>Online</code> has been set to <code>false</code>.</li>
</ol>
<p>We&#x27;ll print an appropriate message in each of these cases.</p>
<p>To <code>Program.cs</code>, add:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#6272A4">/// Our `User.OnUpdate` callback:</span></span>
<span class="line"><span style="color:#6272A4">/// print a notification about name and status changes.</span></span>
<span class="line"><span style="color:#FF79C6">void</span><span style="color:#50FA7B"> User_OnUpdate</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD;font-style:italic">EventContext</span><span style="color:#FFB86C;font-style:italic"> ctx</span><span style="color:#F8F8F2">, </span><span style="color:#8BE9FD;font-style:italic">User</span><span style="color:#FFB86C;font-style:italic"> oldValue</span><span style="color:#F8F8F2">, </span><span style="color:#8BE9FD;font-style:italic">User</span><span style="color:#FFB86C;font-style:italic"> newValue</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">{</span></span>
<span class="line"><span style="color:#FF79C6">    if</span><span style="color:#F8F8F2"> (oldValue.Name </span><span style="color:#FF79C6">!=</span><span style="color:#F8F8F2"> newValue.Name)</span></span>
<span class="line"><span style="color:#F8F8F2">    {</span></span>
<span class="line"><span style="color:#F8F8F2">        Console.</span><span style="color:#50FA7B">WriteLine</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">$&quot;</span><span style="color:#FF79C6">{</span><span style="color:#50FA7B">UserNameOrIdentity</span><span style="color:#F1FA8C">(</span><span style="color:#F8F8F2">oldValue</span><span style="color:#F1FA8C">)</span><span style="color:#FF79C6">}</span><span style="color:#F1FA8C"> renamed to </span><span style="color:#FF79C6">{</span><span style="color:#F8F8F2">newValue</span><span style="color:#F1FA8C">.</span><span style="color:#F8F8F2">Name</span><span style="color:#FF79C6">}</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#FF79C6">    if</span><span style="color:#F8F8F2"> (oldValue.Online </span><span style="color:#FF79C6">!=</span><span style="color:#F8F8F2"> newValue.Online)</span></span>
<span class="line"><span style="color:#F8F8F2">    {</span></span>
<span class="line"><span style="color:#FF79C6">        if</span><span style="color:#F8F8F2"> (newValue.Online)</span></span>
<span class="line"><span style="color:#F8F8F2">        {</span></span>
<span class="line"><span style="color:#F8F8F2">            Console.</span><span style="color:#50FA7B">WriteLine</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">$&quot;</span><span style="color:#FF79C6">{</span><span style="color:#50FA7B">UserNameOrIdentity</span><span style="color:#F1FA8C">(</span><span style="color:#F8F8F2">newValue</span><span style="color:#F1FA8C">)</span><span style="color:#FF79C6">}</span><span style="color:#F1FA8C"> connected.</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#FF79C6">        else</span></span>
<span class="line"><span style="color:#F8F8F2">        {</span></span>
<span class="line"><span style="color:#F8F8F2">            Console.</span><span style="color:#50FA7B">WriteLine</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">$&quot;</span><span style="color:#FF79C6">{</span><span style="color:#50FA7B">UserNameOrIdentity</span><span style="color:#F1FA8C">(</span><span style="color:#F8F8F2">newValue</span><span style="color:#F1FA8C">)</span><span style="color:#FF79C6">}</span><span style="color:#F1FA8C"> disconnected.</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<h3 class="anchor anchorWithStickyNavbar_wKCU" id="print-messages">Print messages<a href="#print-messages" class="hash-link" aria-label="Direct link to Print messages" title="Direct link to Print messages" translate="no">​</a></h3>
<p>When we receive a new message, we&#x27;ll print it to standard output, along with the name of the user who sent it. Keep in mind that we only want to do this for new messages, i.e. those inserted by a <code>SendMessage</code> reducer invocation. We have to handle the backlog we receive when our subscription is initialized separately, to ensure they&#x27;re printed in the correct order. To that effect, our <code>OnInsert</code> callback will check if its <code>ReducerEvent</code> argument is not <code>null</code>, and only print in that case.</p>
<p>To find the <code>User</code> based on the message&#x27;s <code>Sender</code> identity, we&#x27;ll use <code>User.Identity.Find</code>, which behaves like the same function on the server.</p>
<p>We&#x27;ll print the user&#x27;s name or identity in the same way as we did when notifying about <code>User</code> table events, but here we have to handle the case where we don&#x27;t find a matching <code>User</code> row. This can happen when the module owner sends a message using the CLI&#x27;s <code>spacetime call</code>. In this case, we&#x27;ll print <code>unknown</code>.</p>
<p>To <code>Program.cs</code>, add:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#6272A4">/// Our `Message.OnInsert` callback: print new messages.</span></span>
<span class="line"><span style="color:#FF79C6">void</span><span style="color:#50FA7B"> Message_OnInsert</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD;font-style:italic">EventContext</span><span style="color:#FFB86C;font-style:italic"> ctx</span><span style="color:#F8F8F2">, </span><span style="color:#8BE9FD;font-style:italic">Message</span><span style="color:#FFB86C;font-style:italic"> insertedValue</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">{</span></span>
<span class="line"><span style="color:#6272A4">    // We are filtering out messages inserted during the subscription being applied,</span></span>
<span class="line"><span style="color:#6272A4">    // since we will be printing those in the OnSubscriptionApplied callback,</span></span>
<span class="line"><span style="color:#6272A4">    // where we will be able to first sort the messages before printing.</span></span>
<span class="line"><span style="color:#FF79C6">    if</span><span style="color:#F8F8F2"> (ctx.Event </span><span style="color:#FF79C6">is</span><span style="color:#FF79C6"> not</span><span style="color:#8BE9FD;font-style:italic"> Event</span><span style="color:#F8F8F2">&lt;</span><span style="color:#8BE9FD;font-style:italic">Reducer</span><span style="color:#F8F8F2">&gt;.</span><span style="color:#8BE9FD;font-style:italic">SubscribeApplied</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">    {</span></span>
<span class="line"><span style="color:#50FA7B">        PrintMessage</span><span style="color:#F8F8F2">(ctx.Db, insertedValue);</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">void</span><span style="color:#50FA7B"> PrintMessage</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD;font-style:italic">RemoteTables</span><span style="color:#FFB86C;font-style:italic"> tables</span><span style="color:#F8F8F2">, </span><span style="color:#8BE9FD;font-style:italic">Message</span><span style="color:#FFB86C;font-style:italic"> message</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">{</span></span>
<span class="line"><span style="color:#FF79C6">    var</span><span style="color:#F8F8F2"> sender </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> tables.User.Identity.</span><span style="color:#50FA7B">Find</span><span style="color:#F8F8F2">(message.Sender);</span></span>
<span class="line"><span style="color:#FF79C6">    var</span><span style="color:#F8F8F2"> senderName </span><span style="color:#FF79C6">=</span><span style="color:#E9F284"> &quot;</span><span style="color:#F1FA8C">unknown</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#FF79C6">    if</span><span style="color:#F8F8F2"> (sender </span><span style="color:#FF79C6">!=</span><span style="color:#BD93F9"> null</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">    {</span></span>
<span class="line"><span style="color:#F8F8F2">        senderName </span><span style="color:#FF79C6">=</span><span style="color:#50FA7B"> UserNameOrIdentity</span><span style="color:#F8F8F2">(sender);</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">    Console.</span><span style="color:#50FA7B">WriteLine</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">$&quot;</span><span style="color:#FF79C6">{</span><span style="color:#F8F8F2">senderName</span><span style="color:#FF79C6">}</span><span style="color:#F1FA8C">: </span><span style="color:#FF79C6">{</span><span style="color:#F8F8F2">message</span><span style="color:#F1FA8C">.</span><span style="color:#F8F8F2">Text</span><span style="color:#FF79C6">}</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<h3 class="anchor anchorWithStickyNavbar_wKCU" id="warn-if-our-name-was-rejected">Warn if our name was rejected<a href="#warn-if-our-name-was-rejected" class="hash-link" aria-label="Direct link to Warn if our name was rejected" title="Direct link to Warn if our name was rejected" translate="no">​</a></h3>
<p>We can also register callbacks to run each time a reducer is invoked. We register these callbacks using the <code>OnReducerEvent</code> method of the <code>Reducer</code> namespace, which is automatically implemented for each reducer by <code>spacetime generate</code>.</p>
<p>Each reducer callback takes one fixed argument:</p>
<p>The <code>ReducerEventContext</code> of the callback, which contains an <code>Event</code> that contains several fields. The ones we care about are:</p>
<ol>
<li>The <code>CallerIdentity</code>, the <code>Identity</code> of the client that called the reducer.</li>
<li>The <code>Status</code> of the reducer run, one of <code>Committed</code>, <code>Failed</code> or <code>OutOfEnergy</code>.</li>
<li>If we get a <code>Status.Failed</code>, an error message is nested inside that we&#x27;ll want to write to the console.</li>
</ol>
<p>It also takes a variable amount of additional arguments that match the reducer&#x27;s arguments.</p>
<p>These callbacks will be invoked in one of two cases:</p>
<ol>
<li>If the reducer was successful and altered any of our subscribed rows.</li>
<li>If we requested an invocation which failed.</li>
</ol>
<p>Note that a status of <code>Failed</code> or <code>OutOfEnergy</code> implies that the caller identity is our own identity.</p>
<p>We already handle successful <code>SetName</code> invocations using our <code>User.OnUpdate</code> callback, but if the module rejects a user&#x27;s chosen name, we&#x27;d like that user&#x27;s client to let them know. We define a function <code>Reducer_OnSetNameEvent</code> as a <code>Reducer.OnSetNameEvent</code> callback which checks if the reducer failed, and if it did, prints an error message including the rejected name.</p>
<p>We&#x27;ll test both that our identity matches the sender and that the status is <code>Failed</code>, even though the latter implies the former, for demonstration purposes.</p>
<p>To <code>Program.cs</code>, add:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#6272A4">/// Our `OnSetNameEvent` callback: print a warning if the reducer failed.</span></span>
<span class="line"><span style="color:#FF79C6">void</span><span style="color:#50FA7B"> Reducer_OnSetNameEvent</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD;font-style:italic">ReducerEventContext</span><span style="color:#FFB86C;font-style:italic"> ctx</span><span style="color:#F8F8F2">, </span><span style="color:#FF79C6">string</span><span style="color:#FFB86C;font-style:italic"> name</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">{</span></span>
<span class="line"><span style="color:#FF79C6">    var</span><span style="color:#F8F8F2"> e </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> ctx.Event;</span></span>
<span class="line"><span style="color:#FF79C6">    if</span><span style="color:#F8F8F2"> (e.CallerIdentity </span><span style="color:#FF79C6">==</span><span style="color:#F8F8F2"> local_identity </span><span style="color:#FF79C6">&amp;&amp;</span><span style="color:#F8F8F2"> e.Status </span><span style="color:#FF79C6">is</span><span style="color:#8BE9FD;font-style:italic"> Status</span><span style="color:#F8F8F2">.</span><span style="color:#8BE9FD;font-style:italic">Failed</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">var</span><span style="color:#F8F8F2"> error))</span></span>
<span class="line"><span style="color:#F8F8F2">    {</span></span>
<span class="line"><span style="color:#F8F8F2">        Console.</span><span style="color:#50FA7B">Write</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">$&quot;</span><span style="color:#F1FA8C">Failed to change name to </span><span style="color:#FF79C6">{</span><span style="color:#F8F8F2">name</span><span style="color:#FF79C6">}</span><span style="color:#F1FA8C">: </span><span style="color:#FF79C6">{</span><span style="color:#F8F8F2">error</span><span style="color:#FF79C6">}</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<h3 class="anchor anchorWithStickyNavbar_wKCU" id="warn-if-our-message-was-rejected">Warn if our message was rejected<a href="#warn-if-our-message-was-rejected" class="hash-link" aria-label="Direct link to Warn if our message was rejected" title="Direct link to Warn if our message was rejected" translate="no">​</a></h3>
<p>We handle warnings on rejected messages the same way as rejected names, though the types and the error message are different.</p>
<p>To <code>Program.cs</code>, add:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#6272A4">/// Our `OnSendMessageEvent` callback: print a warning if the reducer failed.</span></span>
<span class="line"><span style="color:#FF79C6">void</span><span style="color:#50FA7B"> Reducer_OnSendMessageEvent</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD;font-style:italic">ReducerEventContext</span><span style="color:#FFB86C;font-style:italic"> ctx</span><span style="color:#F8F8F2">, </span><span style="color:#FF79C6">string</span><span style="color:#FFB86C;font-style:italic"> text</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">{</span></span>
<span class="line"><span style="color:#FF79C6">    var</span><span style="color:#F8F8F2"> e </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> ctx.Event;</span></span>
<span class="line"><span style="color:#FF79C6">    if</span><span style="color:#F8F8F2"> (e.CallerIdentity </span><span style="color:#FF79C6">==</span><span style="color:#F8F8F2"> local_identity </span><span style="color:#FF79C6">&amp;&amp;</span><span style="color:#F8F8F2"> e.Status </span><span style="color:#FF79C6">is</span><span style="color:#8BE9FD;font-style:italic"> Status</span><span style="color:#F8F8F2">.</span><span style="color:#8BE9FD;font-style:italic">Failed</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">var</span><span style="color:#F8F8F2"> error))</span></span>
<span class="line"><span style="color:#F8F8F2">    {</span></span>
<span class="line"><span style="color:#F8F8F2">        Console.</span><span style="color:#50FA7B">Write</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">$&quot;</span><span style="color:#F1FA8C">Failed to send message </span><span style="color:#FF79C6">{</span><span style="color:#F8F8F2">text</span><span style="color:#FF79C6">}</span><span style="color:#F1FA8C">: </span><span style="color:#FF79C6">{</span><span style="color:#F8F8F2">error</span><span style="color:#FF79C6">}</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<h2 class="anchor anchorWithStickyNavbar_wKCU" id="subscribe-to-queries">Subscribe to queries<a href="#subscribe-to-queries" class="hash-link" aria-label="Direct link to Subscribe to queries" title="Direct link to Subscribe to queries" translate="no">​</a></h2>
<p>SpacetimeDB is set up so that each client subscribes via SQL queries to some subset of the database, and is notified about changes only to that subset. For complex apps with large databases, judicious subscriptions can save each client significant network bandwidth, memory and computation. For example, in <a href="https://bitcraftonline.com" target="_blank" rel="noopener noreferrer">BitCraft</a>, each player&#x27;s client subscribes only to the entities in the &quot;chunk&quot; of the world where that player currently resides, rather than the entire game world. Our app is much simpler than BitCraft, so we&#x27;ll just subscribe to the whole database using <code>SubscribeToAllTables</code>.</p>
<p>You can also subscribe to specific tables using SQL syntax, e.g. <code>SELECT * FROM my_table</code>. Our <a href="/sql">SQL documentation</a> enumerates the operations that are accepted in our SQL syntax.</p>
<p>When we specify our subscriptions, we can supply an <code>OnApplied</code> callback. This will run when the subscription is applied and the matching rows become available in our client cache. We&#x27;ll use this opportunity to print the message backlog in proper order.</p>
<p>We can also provide an <code>OnError</code> callback. This will run if the subscription fails, usually due to an invalid or malformed SQL queries. We can&#x27;t handle this case, so we&#x27;ll just print out the error and exit the process.</p>
<p>In <code>Program.cs</code>, update our <code>OnConnected</code> function to include <code>conn.SubscriptionBuilder().OnApplied(OnSubscriptionApplied).SubscribeToAllTables();</code> so that it reads:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#6272A4">/// Our `OnConnect` callback: save our credentials to a file.</span></span>
<span class="line"><span style="color:#FF79C6">void</span><span style="color:#50FA7B"> OnConnected</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD;font-style:italic">DbConnection</span><span style="color:#FFB86C;font-style:italic"> conn</span><span style="color:#F8F8F2">, </span><span style="color:#8BE9FD;font-style:italic">Identity</span><span style="color:#FFB86C;font-style:italic"> identity</span><span style="color:#F8F8F2">, </span><span style="color:#FF79C6">string</span><span style="color:#FFB86C;font-style:italic"> authToken</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">{</span></span>
<span class="line"><span style="color:#F8F8F2">    local_identity </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> identity;</span></span>
<span class="line"><span style="color:#F8F8F2">    AuthToken.</span><span style="color:#50FA7B">SaveToken</span><span style="color:#F8F8F2">(authToken);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">    conn.</span><span style="color:#50FA7B">SubscriptionBuilder</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#F8F8F2">        .</span><span style="color:#50FA7B">OnApplied</span><span style="color:#F8F8F2">(OnSubscriptionApplied)</span></span>
<span class="line"><span style="color:#F8F8F2">        .</span><span style="color:#50FA7B">SubscribeToAllTables</span><span style="color:#F8F8F2">();</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<h2 class="anchor anchorWithStickyNavbar_wKCU" id="onsubscriptionapplied-callback">OnSubscriptionApplied callback<a href="#onsubscriptionapplied-callback" class="hash-link" aria-label="Direct link to OnSubscriptionApplied callback" title="Direct link to OnSubscriptionApplied callback" translate="no">​</a></h2>
<p>Once our subscription is applied, we&#x27;ll print all the previously sent messages. We&#x27;ll define a function <code>PrintMessagesInOrder</code> to do this. <code>PrintMessagesInOrder</code> calls the automatically generated <code>Iter</code> function on our <code>Message</code> table, which returns an iterator over all rows in the table. We&#x27;ll use the <code>OrderBy</code> method on the iterator to sort the messages by their <code>Sent</code> timestamp.</p>
<p>To <code>Program.cs</code>, add:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#6272A4">/// Our `OnSubscriptionApplied` callback:</span></span>
<span class="line"><span style="color:#6272A4">/// sort all past messages and print them in timestamp order.</span></span>
<span class="line"><span style="color:#FF79C6">void</span><span style="color:#50FA7B"> OnSubscriptionApplied</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD;font-style:italic">SubscriptionEventContext</span><span style="color:#FFB86C;font-style:italic"> ctx</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">{</span></span>
<span class="line"><span style="color:#F8F8F2">    Console.</span><span style="color:#50FA7B">WriteLine</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">Connected</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#50FA7B">    PrintMessagesInOrder</span><span style="color:#F8F8F2">(ctx.Db);</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">void</span><span style="color:#50FA7B"> PrintMessagesInOrder</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD;font-style:italic">RemoteTables</span><span style="color:#FFB86C;font-style:italic"> tables</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">{</span></span>
<span class="line"><span style="color:#FF79C6">    foreach</span><span style="color:#F8F8F2"> (</span><span style="color:#8BE9FD;font-style:italic">Message</span><span style="color:#F8F8F2"> message </span><span style="color:#FF79C6">in</span><span style="color:#F8F8F2"> tables.Message.</span><span style="color:#50FA7B">Iter</span><span style="color:#F8F8F2">().</span><span style="color:#50FA7B">OrderBy</span><span style="color:#F8F8F2">(</span><span style="color:#FFB86C;font-style:italic">item</span><span style="color:#FF79C6"> =&gt;</span><span style="color:#F8F8F2"> item.Sent))</span></span>
<span class="line"><span style="color:#F8F8F2">    {</span></span>
<span class="line"><span style="color:#50FA7B">        PrintMessage</span><span style="color:#F8F8F2">(tables, message);</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<h2 class="anchor anchorWithStickyNavbar_wKCU" id="process-thread">Process thread<a href="#process-thread" class="hash-link" aria-label="Direct link to Process thread" title="Direct link to Process thread" translate="no">​</a></h2>
<p>Since the input loop will be blocking, we&#x27;ll run our processing code in a separate thread.</p>
<p>This thread will loop until the thread is signaled to exit, calling the update function <code>FrameTick</code> on the <code>DbConnection</code> to process any updates received from the database, and <code>ProcessCommand</code> to process any commands received from the input loop.</p>
<p>Afterward, close the connection to the database.</p>
<p>To <code>Program.cs</code>, add:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#6272A4">/// Our separate thread from main, where we can call process updates and process commands without blocking the main thread.</span></span>
<span class="line"><span style="color:#FF79C6">void</span><span style="color:#50FA7B"> ProcessThread</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD;font-style:italic">DbConnection</span><span style="color:#FFB86C;font-style:italic"> conn</span><span style="color:#F8F8F2">, </span><span style="color:#8BE9FD;font-style:italic">CancellationToken</span><span style="color:#FFB86C;font-style:italic"> ct</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">{</span></span>
<span class="line"><span style="color:#FF79C6">    try</span></span>
<span class="line"><span style="color:#F8F8F2">    {</span></span>
<span class="line"><span style="color:#6272A4">        // loop until cancellation token</span></span>
<span class="line"><span style="color:#FF79C6">        while</span><span style="color:#F8F8F2"> (</span><span style="color:#FF79C6">!</span><span style="color:#F8F8F2">ct.IsCancellationRequested)</span></span>
<span class="line"><span style="color:#F8F8F2">        {</span></span>
<span class="line"><span style="color:#F8F8F2">            conn.</span><span style="color:#50FA7B">FrameTick</span><span style="color:#F8F8F2">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#50FA7B">            ProcessCommands</span><span style="color:#F8F8F2">(conn.Reducers);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">            Thread.</span><span style="color:#50FA7B">Sleep</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">100</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#FF79C6">    finally</span></span>
<span class="line"><span style="color:#F8F8F2">    {</span></span>
<span class="line"><span style="color:#F8F8F2">        conn.</span><span style="color:#50FA7B">Disconnect</span><span style="color:#F8F8F2">();</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<h2 class="anchor anchorWithStickyNavbar_wKCU" id="handle-user-input">Handle user input<a href="#handle-user-input" class="hash-link" aria-label="Direct link to Handle user input" title="Direct link to Handle user input" translate="no">​</a></h2>
<p>The input loop will read commands from standard input and send them to the processing thread using the input queue. The <code>ProcessCommands</code> function is called every 100ms by the processing thread to process any pending commands.</p>
<p>Supported Commands:</p>
<ol>
<li>
<p>Send a message: <code>message</code>, send the message to the database by calling <code>Reducer.SendMessage</code> which is automatically generated by <code>spacetime generate</code>.</p>
</li>
<li>
<p>Set name: <code>name</code>, will send the new name to the database by calling <code>Reducer.SetName</code> which is automatically generated by <code>spacetime generate</code>.</p>
</li>
</ol>
<p>To <code>Program.cs</code>, add:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#6272A4">/// Read each line of standard input, and either set our name or send a message as appropriate.</span></span>
<span class="line"><span style="color:#FF79C6">void</span><span style="color:#50FA7B"> InputLoop</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#F8F8F2">{</span></span>
<span class="line"><span style="color:#FF79C6">    while</span><span style="color:#F8F8F2"> (</span><span style="color:#BD93F9">true</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">    {</span></span>
<span class="line"><span style="color:#FF79C6">        var</span><span style="color:#F8F8F2"> input </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> Console.</span><span style="color:#50FA7B">ReadLine</span><span style="color:#F8F8F2">();</span></span>
<span class="line"><span style="color:#FF79C6">        if</span><span style="color:#F8F8F2"> (input </span><span style="color:#FF79C6">==</span><span style="color:#BD93F9"> null</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">        {</span></span>
<span class="line"><span style="color:#FF79C6">            break</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">        if</span><span style="color:#F8F8F2"> (input.</span><span style="color:#50FA7B">StartsWith</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">/name </span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">))</span></span>
<span class="line"><span style="color:#F8F8F2">        {</span></span>
<span class="line"><span style="color:#F8F8F2">            input_queue.</span><span style="color:#50FA7B">Enqueue</span><span style="color:#F8F8F2">((</span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">name</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">, input[</span><span style="color:#BD93F9">6</span><span style="color:#FF79C6">..</span><span style="color:#F8F8F2">]));</span></span>
<span class="line"><span style="color:#FF79C6">            continue</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#FF79C6">        else</span></span>
<span class="line"><span style="color:#F8F8F2">        {</span></span>
<span class="line"><span style="color:#F8F8F2">            input_queue.</span><span style="color:#50FA7B">Enqueue</span><span style="color:#F8F8F2">((</span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">message</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">, input));</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">void</span><span style="color:#50FA7B"> ProcessCommands</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD;font-style:italic">RemoteReducers</span><span style="color:#FFB86C;font-style:italic"> reducers</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">{</span></span>
<span class="line"><span style="color:#6272A4">    // process input queue commands</span></span>
<span class="line"><span style="color:#FF79C6">    while</span><span style="color:#F8F8F2"> (input_queue.</span><span style="color:#50FA7B">TryDequeue</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">out</span><span style="color:#FF79C6"> var</span><span style="color:#F8F8F2"> command))</span></span>
<span class="line"><span style="color:#F8F8F2">    {</span></span>
<span class="line"><span style="color:#FF79C6">        switch</span><span style="color:#F8F8F2"> (command.Command)</span></span>
<span class="line"><span style="color:#F8F8F2">        {</span></span>
<span class="line"><span style="color:#FF79C6">            case</span><span style="color:#E9F284"> &quot;</span><span style="color:#F1FA8C">message</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#F8F8F2">                reducers.</span><span style="color:#50FA7B">SendMessage</span><span style="color:#F8F8F2">(command.Args);</span></span>
<span class="line"><span style="color:#FF79C6">                break</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#FF79C6">            case</span><span style="color:#E9F284"> &quot;</span><span style="color:#F1FA8C">name</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#F8F8F2">                reducers.</span><span style="color:#50FA7B">SetName</span><span style="color:#F8F8F2">(command.Args);</span></span>
<span class="line"><span style="color:#FF79C6">                break</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<h2 class="anchor anchorWithStickyNavbar_wKCU" id="run-the-client">Run the client<a href="#run-the-client" class="hash-link" aria-label="Direct link to Run the client" title="Direct link to Run the client" translate="no">​</a></h2>
<p>Finally, we just need to add a call to <code>Main</code>.</p>
<p>To <code>Program.cs</code>, add:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#50FA7B">Main</span><span style="color:#F8F8F2">();</span></span></code></pre>
<p>Now, we can run the client by hitting start in Visual Studio or Rider; or by running the following command in the <code>client</code> directory:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#50FA7B">dotnet</span><span style="color:#F1FA8C"> run</span><span style="color:#BD93F9"> --project</span><span style="color:#F1FA8C"> client</span></span></code></pre>
<h2 class="anchor anchorWithStickyNavbar_wKCU" id="whats-next">What&#x27;s next?<a href="#whats-next" class="hash-link" aria-label="Direct link to What&#x27;s next?" title="Direct link to What&#x27;s next?" translate="no">​</a></h2>
<p>Congratulations! You&#x27;ve built a simple chat app using SpacetimeDB.</p>
<p>You can find the full code for this client <a href="https://github.com/clockworklabs/SpacetimeDB/tree/master/sdks/csharp/examples~/quickstart-chat/client" target="_blank" rel="noopener noreferrer">in the C# client SDK&#x27;s examples</a>.</p>
<p>Check out the <a href="/sdks/c-sharp">C# client SDK Reference</a> for a more comprehensive view of the SpacetimeDB C# client SDK.</p>
<p>If you are interested in developing in the Unity game engine, check out our <a href="/unity">Unity Comprehensive Tutorial</a> and <a href="https://github.com/clockworklabs/SpacetimeDB/tree/master/demo/Blackholio" target="_blank" rel="noopener noreferrer">Blackholio</a> game example.</p></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/sdks"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Overview</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/sdks/c-sharp"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">C# Reference</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_Ea_L thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#project-structure" class="table-of-contents__link toc-highlight">Project structure</a></li><li><a href="#add-the-nuget-package-for-the-c-spacetimedb-sdk" class="table-of-contents__link toc-highlight">Add the NuGet package for the C# SpacetimeDB SDK</a></li><li><a href="#clear-clientprogramcs" class="table-of-contents__link toc-highlight">Clear <code>client/Program.cs</code></a></li><li><a href="#generate-your-module-types" class="table-of-contents__link toc-highlight">Generate your module types</a></li><li><a href="#add-imports-to-programcs" class="table-of-contents__link toc-highlight">Add imports to Program.cs</a></li><li><a href="#define-main-function" class="table-of-contents__link toc-highlight">Define Main function</a></li><li><a href="#connect-to-database" class="table-of-contents__link toc-highlight">Connect to database</a><ul><li><a href="#save-credentials" class="table-of-contents__link toc-highlight">Save credentials</a></li><li><a href="#connect-error-callback" class="table-of-contents__link toc-highlight">Connect Error callback</a></li><li><a href="#disconnect-callback" class="table-of-contents__link toc-highlight">Disconnect callback</a></li></ul></li><li><a href="#register-callbacks" class="table-of-contents__link toc-highlight">Register callbacks</a><ul><li><a href="#notify-about-new-users" class="table-of-contents__link toc-highlight">Notify about new users</a></li><li><a href="#notify-about-updated-users" class="table-of-contents__link toc-highlight">Notify about updated users</a></li><li><a href="#print-messages" class="table-of-contents__link toc-highlight">Print messages</a></li><li><a href="#warn-if-our-name-was-rejected" class="table-of-contents__link toc-highlight">Warn if our name was rejected</a></li><li><a href="#warn-if-our-message-was-rejected" class="table-of-contents__link toc-highlight">Warn if our message was rejected</a></li></ul></li><li><a href="#subscribe-to-queries" class="table-of-contents__link toc-highlight">Subscribe to queries</a></li><li><a href="#onsubscriptionapplied-callback" class="table-of-contents__link toc-highlight">OnSubscriptionApplied callback</a></li><li><a href="#process-thread" class="table-of-contents__link toc-highlight">Process thread</a></li><li><a href="#handle-user-input" class="table-of-contents__link toc-highlight">Handle user input</a></li><li><a href="#run-the-client" class="table-of-contents__link toc-highlight">Run the client</a></li><li><a href="#whats-next" class="table-of-contents__link toc-highlight">What&#39;s next?</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer"><div class="container container-fluid"></div></footer></div>
</body>
</html>