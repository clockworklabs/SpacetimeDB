<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Client SDK Languages/Rust-Quickstart" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.1">
<title data-rh="true">Rust Quickstart | SpacetimeDB docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.spacetimedb.com/sdks/rust/quickstart"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Rust Quickstart | SpacetimeDB docs"><meta data-rh="true" name="description" content="In this guide we&#x27;ll show you how to get up and running with a simple SpacetimeDB app with a client written in Rust."><meta data-rh="true" property="og:description" content="In this guide we&#x27;ll show you how to get up and running with a simple SpacetimeDB app with a client written in Rust."><link data-rh="true" rel="icon" href="/images/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.spacetimedb.com/sdks/rust/quickstart"><link data-rh="true" rel="alternate" href="https://docs.spacetimedb.com/sdks/rust/quickstart" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.spacetimedb.com/sdks/rust/quickstart" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://QBC7Z9KXS2-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Rust Quickstart","item":"https://docs.spacetimedb.com/sdks/rust/quickstart"}]}</script><link rel="search" type="application/opensearchdescription+xml" title="SpacetimeDB docs" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.0cb9f7a7.css">
<script src="/assets/js/runtime~main.d71df0f5.js" defer="defer"></script>
<script src="/assets/js/main.31d95d83.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>document.documentElement.setAttribute("data-theme","light"),document.documentElement.setAttribute("data-theme-choice","light"),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="https://spacetimedb.com/images/brand.png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_6jFv" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="https://spacetimedb.com/images/brand.png" alt="SpacetimeDB Logo" class="themedComponent_rvet themedComponent--light_mbAJ"><img src="https://spacetimedb.com/images/brand.png" alt="SpacetimeDB Logo" class="themedComponent_rvet themedComponent--dark_Ncy6"></div></a><div class="navbarSearchContainer_AesG"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://spacetimedb.com/install" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Install</a><a href="https://spacetimedb.com/pricing" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Pricing</a><a href="https://spacetimedb.com/maincloud" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Maincloud</a><a href="https://spacetimedb.com/blog" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Blog</a><a href="https://spacetimedb.com/community" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Community</a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_hV_y"><div class="docsWrapper_f07g"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_MJiz" type="button"></button><div class="docRoot_Gd2s"><aside class="theme-doc-sidebar-container docSidebarContainer_fSpF"><div class="sidebarViewport_YElg"><div class="sidebar_kjg4"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_AG0n"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/"><span title="Intro" class="categoryLinkLabel_EDYQ">Intro</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/deploying/maincloud"><span title="Deploying" class="categoryLinkLabel_EDYQ">Deploying</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/unity"><span title="Unity tutorial" class="categoryLinkLabel_EDYQ">Unity tutorial</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/unreal"><span title="Unreal Tutorial" class="categoryLinkLabel_EDYQ">Unreal Tutorial</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/cli-reference"><span title="CLI Reference" class="categoryLinkLabel_EDYQ">CLI Reference</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/modules"><span title="Server Module Languages" class="categoryLinkLabel_EDYQ">Server Module Languages</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/sdks"><span title="Client SDK Languages" class="categoryLinkLabel_EDYQ">Client SDK Languages</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/sdks"><span title="Overview" class="linkLabel_dpMB">Overview</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/sdks/c-sharp/quickstart"><span title="C# Quickstart" class="linkLabel_dpMB">C# Quickstart</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/sdks/c-sharp"><span title="C# Reference" class="linkLabel_dpMB">C# Reference</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/sdks/rust/quickstart"><span title="Rust Quickstart" class="linkLabel_dpMB">Rust Quickstart</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/sdks/rust"><span title="Rust Reference" class="linkLabel_dpMB">Rust Reference</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/sdks/typescript/quickstart"><span title="TypeScript Quickstart" class="linkLabel_dpMB">TypeScript Quickstart</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/sdks/typescript"><span title="TypeScript Reference" class="linkLabel_dpMB">TypeScript Reference</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/sql"><span title="SQL" class="categoryLinkLabel_EDYQ">SQL</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/subscriptions"><span title="Subscriptions" class="categoryLinkLabel_EDYQ">Subscriptions</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/rls"><span title="Row Level Security" class="linkLabel_dpMB">Row Level Security</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/how-to/incremental-migrations"><span title="How-To" class="categoryLinkLabel_EDYQ">How-To</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/spacetimeauth"><span title="SpacetimeAuth" class="categoryLinkLabel_EDYQ">SpacetimeAuth</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/http/authorization"><span title="HTTP API" class="categoryLinkLabel_EDYQ">HTTP API</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/webassembly-abi"><span title="Internals" class="categoryLinkLabel_EDYQ">Internals</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/appendix"><span title="Appendix" class="linkLabel_dpMB">Appendix</span></a></li></ul></nav></div></div></aside><main class="docMainContainer_dkUT"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_w2oE"><div class="docItemContainer_f71m"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_xsLZ" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_oyay"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Client SDK Languages</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Rust Quickstart</span></li></ul></nav><div class="tocCollapsible_dqme theme-doc-toc-mobile tocMobile_Z34P"><button type="button" class="clean-btn tocCollapsibleButton_QMSE">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Rust Client SDK Quick Start</h1></header>
<p>In this guide we&#x27;ll show you how to get up and running with a simple SpacetimeDB app with a client written in Rust.</p>
<p>We&#x27;ll implement a command-line client for the module created in our Rust or C# Module Quickstart guides. Make sure you follow one of these guides before you start on this one.</p>
<h2 class="anchor anchorWithStickyNavbar_wKCU" id="project-structure">Project structure<a href="#project-structure" class="hash-link" aria-label="Direct link to Project structure" title="Direct link to Project structure" translate="no">​</a></h2>
<p>Enter the directory <code>quickstart-chat</code> you created in the <a href="/modules/rust/quickstart">Rust Module Quickstart</a> or <a href="/modules/c-sharp/quickstart">C# Module Quickstart</a> guides:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#8BE9FD">cd</span><span style="color:#F1FA8C"> quickstart-chat</span></span></code></pre>
<p>Within it, create a <code>client</code> crate, our client application, which users run locally:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#50FA7B">cargo</span><span style="color:#F1FA8C"> new</span><span style="color:#F1FA8C"> client</span></span></code></pre>
<h2 class="anchor anchorWithStickyNavbar_wKCU" id="depend-on-spacetimedb-sdk-and-hex">Depend on <code>spacetimedb-sdk</code> and <code>hex</code><a href="#depend-on-spacetimedb-sdk-and-hex" class="hash-link" aria-label="Direct link to depend-on-spacetimedb-sdk-and-hex" title="Direct link to depend-on-spacetimedb-sdk-and-hex" translate="no">​</a></h2>
<p><code>client/Cargo.toml</code> should be initialized without any dependencies. We&#x27;ll need two:</p>
<ul>
<li><a href="https://crates.io/crates/spacetimedb-sdk" target="_blank" rel="noopener noreferrer"><code>spacetimedb-sdk</code></a>, which defines client-side interfaces for interacting with a remote SpacetimeDB database.</li>
<li><a href="https://crates.io/crates/hex" target="_blank" rel="noopener noreferrer"><code>hex</code></a>, which we&#x27;ll use to print unnamed users&#x27; identities as hexadecimal strings.</li>
</ul>
<p>Below the <code>[dependencies]</code> line in <code>client/Cargo.toml</code>, add:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#8BE9FD">spacetimedb-sdk</span><span style="color:#FF79C6"> =</span><span style="color:#E9F284"> &quot;</span><span style="color:#F1FA8C">1.0</span><span style="color:#E9F284">&quot;</span></span>
<span class="line"><span style="color:#8BE9FD">hex</span><span style="color:#FF79C6"> =</span><span style="color:#E9F284"> &quot;</span><span style="color:#F1FA8C">0.4</span><span style="color:#E9F284">&quot;</span></span></code></pre>
<p>Make sure you depend on the same version of <code>spacetimedb-sdk</code> as is reported by the SpacetimeDB CLI tool&#x27;s <code>spacetime version</code>!</p>
<h2 class="anchor anchorWithStickyNavbar_wKCU" id="clear-clientsrcmainrs">Clear <code>client/src/main.rs</code><a href="#clear-clientsrcmainrs" class="hash-link" aria-label="Direct link to clear-clientsrcmainrs" title="Direct link to clear-clientsrcmainrs" translate="no">​</a></h2>
<p><code>client/src/main.rs</code> should be initialized with a trivial &quot;Hello world&quot; program. Clear it out so we can write our chat client.</p>
<p>In your <code>quickstart-chat</code> directory, run:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#50FA7B">rm</span><span style="color:#F1FA8C"> client/src/main.rs</span></span>
<span class="line"><span style="color:#50FA7B">touch</span><span style="color:#F1FA8C"> client/src/main.rs</span></span></code></pre>
<h2 class="anchor anchorWithStickyNavbar_wKCU" id="generate-your-module-types">Generate your module types<a href="#generate-your-module-types" class="hash-link" aria-label="Direct link to Generate your module types" title="Direct link to Generate your module types" translate="no">​</a></h2>
<p>The <code>spacetime</code> CLI&#x27;s <code>generate</code> command will generate client-side interfaces for the tables, reducers and types referenced by tables or reducers defined in your server module.</p>
<p>In your <code>quickstart-chat</code> directory, run:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#50FA7B">mkdir</span><span style="color:#BD93F9"> -p</span><span style="color:#F1FA8C"> client/src/module_bindings</span></span>
<span class="line"><span style="color:#50FA7B">spacetime</span><span style="color:#F1FA8C"> generate</span><span style="color:#BD93F9"> --lang</span><span style="color:#F1FA8C"> rust</span><span style="color:#BD93F9"> --out-dir</span><span style="color:#F1FA8C"> client/src/module_bindings</span><span style="color:#BD93F9"> --project-path</span><span style="color:#F1FA8C"> server</span></span></code></pre>
<p>Take a look inside <code>client/src/module_bindings</code>. The CLI should have generated a few files:</p>
<div class="language-text codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_p1l2"><pre tabindex="0" class="prism-code language-text codeBlock_qbrE thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="token-line" style="color:#bfc7d5"><span class="token plain">module_bindings/</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">├── identity_connected_reducer.rs</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">├── identity_disconnected_reducer.rs</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">├── message_table.rs</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">├── message_type.rs</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">├── mod.rs</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">├── send_message_reducer.rs</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">├── set_name_reducer.rs</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">├── user_table.rs</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">└── user_type.rs</span><br></span></code></pre></div></div>
<p>To use these, we&#x27;ll declare the module in our client crate and import its definitions.</p>
<p>To <code>client/src/main.rs</code>, add:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#FF79C6">mod</span><span style="color:#F8F8F2"> module_bindings;</span></span>
<span class="line"><span style="color:#FF79C6">use</span><span style="color:#F8F8F2"> module_bindings</span><span style="color:#FF79C6">::*</span><span style="color:#F8F8F2">;</span></span></code></pre>
<h2 class="anchor anchorWithStickyNavbar_wKCU" id="add-more-imports">Add more imports<a href="#add-more-imports" class="hash-link" aria-label="Direct link to Add more imports" title="Direct link to Add more imports" translate="no">​</a></h2>
<p>We&#x27;ll need additional imports from <code>spacetimedb_sdk</code> for interacting with the database, handling credentials, and managing events.</p>
<p>To <code>client/src/main.rs</code>, add:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#FF79C6">use</span><span style="color:#F8F8F2"> spacetimedb_sdk</span><span style="color:#FF79C6">::</span><span style="color:#F8F8F2">{credentials, </span><span style="color:#8BE9FD;font-style:italic">DbContext</span><span style="color:#F8F8F2">, </span><span style="color:#8BE9FD;font-style:italic">Error</span><span style="color:#F8F8F2">, </span><span style="color:#8BE9FD;font-style:italic">Event</span><span style="color:#F8F8F2">, </span><span style="color:#8BE9FD;font-style:italic">Identity</span><span style="color:#F8F8F2">, </span><span style="color:#8BE9FD;font-style:italic">Status</span><span style="color:#F8F8F2">, </span><span style="color:#8BE9FD;font-style:italic">Table</span><span style="color:#F8F8F2">, </span><span style="color:#8BE9FD;font-style:italic">TableWithPrimaryKey</span><span style="color:#F8F8F2">};</span></span></code></pre>
<h2 class="anchor anchorWithStickyNavbar_wKCU" id="define-the-main-function">Define the main function<a href="#define-the-main-function" class="hash-link" aria-label="Direct link to Define the main function" title="Direct link to Define the main function" translate="no">​</a></h2>
<p>Our <code>main</code> function will do the following:</p>
<ol>
<li>Connect to the database.</li>
<li>Register a number of callbacks to run in response to various database events.</li>
<li>Subscribe to a set of SQL queries, whose results will be replicated and automatically updated in our client.</li>
<li>Spawn a background thread where our connection will process messages and invoke callbacks.</li>
<li>Enter a loop to handle user input from the command line.</li>
</ol>
<p>We&#x27;ll see the implementation of these functions a bit later, but for now add to <code>client/src/main.rs</code>:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#FF79C6">fn</span><span style="color:#50FA7B"> main</span><span style="color:#F8F8F2">() {</span></span>
<span class="line"><span style="color:#6272A4">    // Connect to the database</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> ctx </span><span style="color:#FF79C6">=</span><span style="color:#50FA7B"> connect_to_db</span><span style="color:#F8F8F2">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">    // Register callbacks to run in response to database events.</span></span>
<span class="line"><span style="color:#50FA7B">    register_callbacks</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">&amp;</span><span style="color:#F8F8F2">ctx);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">    // Subscribe to SQL queries in order to construct a local partial replica of the database.</span></span>
<span class="line"><span style="color:#50FA7B">    subscribe_to_tables</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">&amp;</span><span style="color:#F8F8F2">ctx);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">    // Spawn a thread, where the connection will process messages and invoke callbacks.</span></span>
<span class="line"><span style="color:#F8F8F2">    ctx</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">run_threaded</span><span style="color:#F8F8F2">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">    // Handle CLI input</span></span>
<span class="line"><span style="color:#50FA7B">    user_input_loop</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">&amp;</span><span style="color:#F8F8F2">ctx);</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<h2 class="anchor anchorWithStickyNavbar_wKCU" id="connect-to-the-database">Connect to the database<a href="#connect-to-the-database" class="hash-link" aria-label="Direct link to Connect to the database" title="Direct link to Connect to the database" translate="no">​</a></h2>
<p>A connection to a SpacetimeDB database is represented by a <code>DbConnection</code>. We configure <code>DbConnection</code>s using the builder pattern, by calling <code>DbConnection::builder()</code>, chaining method calls to set various connection parameters and register callbacks, then we cap it off with a call to <code>.build()</code> to begin the connection.</p>
<p>In our case, we&#x27;ll supply the following options:</p>
<ol>
<li>An <code>on_connect</code> callback, to run when the remote database acknowledges and accepts our connection.</li>
<li>An <code>on_connect_error</code> callback, to run if the remote database is unreachable or it rejects our connection.</li>
<li>An <code>on_disconnect</code> callback, to run when our connection ends.</li>
<li>A <code>with_token</code> call, to supply a token to authenticate with.</li>
<li>A <code>with_module_name</code> call, to specify the name or <code>Identity</code> of our database. Make sure to pass the same name here as you supplied to <code>spacetime publish</code>.</li>
<li>A <code>with_uri</code> call, to specify the URI of the SpacetimeDB host where our database is running.</li>
</ol>
<p>To <code>client/src/main.rs</code>, add:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#6272A4">/// The URI of the SpacetimeDB instance hosting our chat database and module.</span></span>
<span class="line"><span style="color:#FF79C6">const</span><span style="color:#BD93F9"> HOST</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">str</span><span style="color:#FF79C6"> =</span><span style="color:#F1FA8C"> &quot;http://localhost:3000&quot;</span><span style="color:#F8F8F2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">/// The database name we chose when we published our module.</span></span>
<span class="line"><span style="color:#FF79C6">const</span><span style="color:#BD93F9"> DB_NAME</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">str</span><span style="color:#FF79C6"> =</span><span style="color:#F1FA8C"> &quot;quickstart-chat&quot;</span><span style="color:#F8F8F2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">/// Load credentials from a file and connect to the database.</span></span>
<span class="line"><span style="color:#FF79C6">fn</span><span style="color:#50FA7B"> connect_to_db</span><span style="color:#F8F8F2">() </span><span style="color:#FF79C6">-&gt;</span><span style="color:#8BE9FD;font-style:italic"> DbConnection</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#8BE9FD;font-style:italic">    DbConnection</span><span style="color:#FF79C6">::</span><span style="color:#50FA7B">builder</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#6272A4">        // Register our `on_connect` callback, which will save our auth token.</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">on_connect</span><span style="color:#F8F8F2">(on_connected)</span></span>
<span class="line"><span style="color:#6272A4">        // Register our `on_connect_error` callback, which will print a message, then exit the process.</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">on_connect_error</span><span style="color:#F8F8F2">(on_connect_error)</span></span>
<span class="line"><span style="color:#6272A4">        // Our `on_disconnect` callback, which will print a message, then exit the process.</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">on_disconnect</span><span style="color:#F8F8F2">(on_disconnected)</span></span>
<span class="line"><span style="color:#6272A4">        // If the user has previously connected, we&#x27;ll have saved a token in the `on_connect` callback.</span></span>
<span class="line"><span style="color:#6272A4">        // In that case, we&#x27;ll load it and pass it to `with_token`,</span></span>
<span class="line"><span style="color:#6272A4">        // so we can re-authenticate as the same `Identity`.</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">with_token</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B">creds_store</span><span style="color:#F8F8F2">()</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">load</span><span style="color:#F8F8F2">()</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">expect</span><span style="color:#F8F8F2">(</span><span style="color:#F1FA8C">&quot;Error loading credentials&quot;</span><span style="color:#F8F8F2">))</span></span>
<span class="line"><span style="color:#6272A4">        // Set the database name we chose when we called `spacetime publish`.</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">with_module_name</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">DB_NAME</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#6272A4">        // Set the URI of the SpacetimeDB host that&#x27;s running our database.</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">with_uri</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">HOST</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#6272A4">        // Finalize configuration and connect!</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">build</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">expect</span><span style="color:#F8F8F2">(</span><span style="color:#F1FA8C">&quot;Failed to connect&quot;</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<h3 class="anchor anchorWithStickyNavbar_wKCU" id="save-credentials">Save credentials<a href="#save-credentials" class="hash-link" aria-label="Direct link to Save credentials" title="Direct link to Save credentials" translate="no">​</a></h3>
<p>SpacetimeDB will accept any <a href="https://openid.net/developers/how-connect-works/" target="_blank" rel="noopener noreferrer">OpenID Connect</a> compliant <a href="https://jwt.io/" target="_blank" rel="noopener noreferrer">JSON Web Token</a> and use it to compute an <code>Identity</code> for the user. More complex applications will generally authenticate their user somehow, generate or retrieve a token, and attach it to their connection via <code>with_token</code>. In our case, though, we&#x27;ll connect anonymously the first time, let SpacetimeDB generate a fresh <code>Identity</code> and corresponding JWT for us, and save that token locally to re-use the next time we connect.</p>
<p>The Rust SDK provides a pair of functions in <code>File</code>, <code>save</code> and <code>load</code>, for saving and storing these credentials in a file. By default the <code>save</code> and <code>load</code> will look for credentials in the <code>$HOME/.spacetimedb_client_credentials/</code> directory, which should be unintrusive. If saving our credentials fails, we&#x27;ll print a message to standard error, but otherwise continue; even though the user won&#x27;t be able to reconnect with the same identity, they can still chat normally.</p>
<p>To <code>client/src/main.rs</code>, add:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#FF79C6">fn</span><span style="color:#50FA7B"> creds_store</span><span style="color:#F8F8F2">() </span><span style="color:#FF79C6">-&gt;</span><span style="color:#F8F8F2"> credentials</span><span style="color:#FF79C6">::</span><span style="color:#8BE9FD;font-style:italic">File</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#F8F8F2">    credentials</span><span style="color:#FF79C6">::</span><span style="color:#8BE9FD;font-style:italic">File</span><span style="color:#FF79C6">::</span><span style="color:#50FA7B">new</span><span style="color:#F8F8F2">(</span><span style="color:#F1FA8C">&quot;quickstart-chat&quot;</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">/// Our `on_connect` callback: save our credentials to a file.</span></span>
<span class="line"><span style="color:#FF79C6">fn</span><span style="color:#50FA7B"> on_connected</span><span style="color:#F8F8F2">(_ctx</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">DbConnection</span><span style="color:#F8F8F2">, _identity</span><span style="color:#FF79C6">:</span><span style="color:#8BE9FD;font-style:italic"> Identity</span><span style="color:#F8F8F2">, token</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">str</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#FF79C6">    if</span><span style="color:#FF79C6"> let</span><span style="color:#8BE9FD;font-style:italic"> Err</span><span style="color:#F8F8F2">(e) </span><span style="color:#FF79C6">=</span><span style="color:#50FA7B"> creds_store</span><span style="color:#F8F8F2">()</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">save</span><span style="color:#F8F8F2">(token) {</span></span>
<span class="line"><span style="color:#50FA7B">        eprintln!</span><span style="color:#F8F8F2">(</span><span style="color:#F1FA8C">&quot;Failed to save credentials: {:?}&quot;</span><span style="color:#F8F8F2">, e);</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<h3 class="anchor anchorWithStickyNavbar_wKCU" id="handle-errors-and-disconnections">Handle errors and disconnections<a href="#handle-errors-and-disconnections" class="hash-link" aria-label="Direct link to Handle errors and disconnections" title="Direct link to Handle errors and disconnections" translate="no">​</a></h3>
<p>We need to handle connection errors and disconnections by printing appropriate messages and exiting the program. These callbacks take an <code>ErrorContext</code>, a <code>DbConnection</code> that&#x27;s been augmented with information about the error that occured.</p>
<p>To <code>client/src/main.rs</code>, add:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#6272A4">/// Our `on_connect_error` callback: print the error, then exit the process.</span></span>
<span class="line"><span style="color:#FF79C6">fn</span><span style="color:#50FA7B"> on_connect_error</span><span style="color:#F8F8F2">(_ctx</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">ErrorContext</span><span style="color:#F8F8F2">, err</span><span style="color:#FF79C6">:</span><span style="color:#8BE9FD;font-style:italic"> Error</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#50FA7B">    eprintln!</span><span style="color:#F8F8F2">(</span><span style="color:#F1FA8C">&quot;Connection error: {:?}&quot;</span><span style="color:#F8F8F2">, err);</span></span>
<span class="line"><span style="color:#F8F8F2">    std</span><span style="color:#FF79C6">::</span><span style="color:#F8F8F2">process</span><span style="color:#FF79C6">::</span><span style="color:#50FA7B">exit</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">/// Our `on_disconnect` callback: print a note, then exit the process.</span></span>
<span class="line"><span style="color:#FF79C6">fn</span><span style="color:#50FA7B"> on_disconnected</span><span style="color:#F8F8F2">(_ctx</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">ErrorContext</span><span style="color:#F8F8F2">, err</span><span style="color:#FF79C6">:</span><span style="color:#8BE9FD;font-style:italic"> Option</span><span style="color:#F8F8F2">&lt;</span><span style="color:#8BE9FD;font-style:italic">Error</span><span style="color:#F8F8F2">&gt;) {</span></span>
<span class="line"><span style="color:#FF79C6">    if</span><span style="color:#FF79C6"> let</span><span style="color:#8BE9FD;font-style:italic"> Some</span><span style="color:#F8F8F2">(err) </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> err {</span></span>
<span class="line"><span style="color:#50FA7B">        eprintln!</span><span style="color:#F8F8F2">(</span><span style="color:#F1FA8C">&quot;Disconnected: {}&quot;</span><span style="color:#F8F8F2">, err);</span></span>
<span class="line"><span style="color:#F8F8F2">        std</span><span style="color:#FF79C6">::</span><span style="color:#F8F8F2">process</span><span style="color:#FF79C6">::</span><span style="color:#50FA7B">exit</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">    } </span><span style="color:#FF79C6">else</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#50FA7B">        println!</span><span style="color:#F8F8F2">(</span><span style="color:#F1FA8C">&quot;Disconnected.&quot;</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">        std</span><span style="color:#FF79C6">::</span><span style="color:#F8F8F2">process</span><span style="color:#FF79C6">::</span><span style="color:#50FA7B">exit</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<h2 class="anchor anchorWithStickyNavbar_wKCU" id="register-callbacks">Register callbacks<a href="#register-callbacks" class="hash-link" aria-label="Direct link to Register callbacks" title="Direct link to Register callbacks" translate="no">​</a></h2>
<p>We need to handle several sorts of events:</p>
<ol>
<li>When a new user joins, we&#x27;ll print a message introducing them.</li>
<li>When a user is updated, we&#x27;ll print their new name, or declare their new online status.</li>
<li>When we receive a new message, we&#x27;ll print it.</li>
<li>If the server rejects our attempt to set our name, we&#x27;ll print an error.</li>
<li>If the server rejects a message we send, we&#x27;ll print an error.</li>
</ol>
<p>To <code>client/src/main.rs</code>, add:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#6272A4">/// Register all the callbacks our app will use to respond to database events.</span></span>
<span class="line"><span style="color:#FF79C6">fn</span><span style="color:#50FA7B"> register_callbacks</span><span style="color:#F8F8F2">(ctx</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">DbConnection</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#6272A4">    // When a new user joins, print a notification.</span></span>
<span class="line"><span style="color:#F8F8F2">    ctx</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">db</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">user</span><span style="color:#F8F8F2">()</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">on_insert</span><span style="color:#F8F8F2">(on_user_inserted);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">    // When a user&#x27;s status changes, print a notification.</span></span>
<span class="line"><span style="color:#F8F8F2">    ctx</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">db</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">user</span><span style="color:#F8F8F2">()</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">on_update</span><span style="color:#F8F8F2">(on_user_updated);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">    // When a new message is received, print it.</span></span>
<span class="line"><span style="color:#F8F8F2">    ctx</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">db</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">message</span><span style="color:#F8F8F2">()</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">on_insert</span><span style="color:#F8F8F2">(on_message_inserted);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">    // When we fail to set our name, print a warning.</span></span>
<span class="line"><span style="color:#F8F8F2">    ctx</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">reducers</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">on_set_name</span><span style="color:#F8F8F2">(on_name_set);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">    // When we fail to send a message, print a warning.</span></span>
<span class="line"><span style="color:#F8F8F2">    ctx</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">reducers</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">on_send_message</span><span style="color:#F8F8F2">(on_message_sent);</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<h3 class="anchor anchorWithStickyNavbar_wKCU" id="notify-about-new-users">Notify about new users<a href="#notify-about-new-users" class="hash-link" aria-label="Direct link to Notify about new users" title="Direct link to Notify about new users" translate="no">​</a></h3>
<p>For each table, we can register on-insert and on-delete callbacks to be run whenever a subscribed row is inserted or deleted. We register these callbacks using the <code>on_insert</code> and <code>on_delete</code>, which is automatically implemented for each table by <code>spacetime generate</code>.</p>
<p>These callbacks can fire in several contexts, of which we care about two:</p>
<ul>
<li>After a reducer runs, when the client&#x27;s cache is updated about changes to subscribed rows.</li>
<li>After calling <code>subscribe</code>, when the client&#x27;s cache is initialized with all existing matching rows.</li>
</ul>
<p>This second case means that, even though the module only ever inserts online users, the client&#x27;s <code>conn.db.user().on_insert(..)</code> callbacks may be invoked with users who are offline. We&#x27;ll only notify about online users.</p>
<p><code>on_insert</code> and <code>on_delete</code> callbacks take two arguments: an <code>&amp;EventContext</code> and the modified row. Like the <code>ErrorContext</code> above, <code>EventContext</code> is a <code>DbConnection</code> that&#x27;s been augmented with information about the event that caused the row to be modified. You can determine whether the insert/delete operation was caused by a reducer, a newly-applied subscription, or some other event by pattern-matching on <code>ctx.event</code>.</p>
<p>Whenever we want to print a user, if they have set a name, we&#x27;ll use that. If they haven&#x27;t set a name, we&#x27;ll instead print the first 8 bytes of their identity, encoded as hexadecimal. We&#x27;ll define functions <code>user_name_or_identity</code> and <code>identity_leading_hex</code> to handle this.</p>
<p>To <code>client/src/main.rs</code>, add:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#6272A4">/// Our `User::on_insert` callback:</span></span>
<span class="line"><span style="color:#6272A4">/// if the user is online, print a notification.</span></span>
<span class="line"><span style="color:#FF79C6">fn</span><span style="color:#50FA7B"> on_user_inserted</span><span style="color:#F8F8F2">(_ctx</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">EventContext</span><span style="color:#F8F8F2">, user</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">User</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#FF79C6">    if</span><span style="color:#F8F8F2"> user</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">online {</span></span>
<span class="line"><span style="color:#50FA7B">        println!</span><span style="color:#F8F8F2">(</span><span style="color:#F1FA8C">&quot;User {} connected.&quot;</span><span style="color:#F8F8F2">, </span><span style="color:#50FA7B">user_name_or_identity</span><span style="color:#F8F8F2">(user));</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">fn</span><span style="color:#50FA7B"> user_name_or_identity</span><span style="color:#F8F8F2">(user</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">User</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">-&gt;</span><span style="color:#8BE9FD;font-style:italic"> String</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#F8F8F2">    user</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">name</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">clone</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">unwrap_or_else</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">||</span><span style="color:#F8F8F2"> user</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">identity</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">to_hex</span><span style="color:#F8F8F2">()</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">to_string</span><span style="color:#F8F8F2">())</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<h3 class="anchor anchorWithStickyNavbar_wKCU" id="notify-about-updated-users">Notify about updated users<a href="#notify-about-updated-users" class="hash-link" aria-label="Direct link to Notify about updated users" title="Direct link to Notify about updated users" translate="no">​</a></h3>
<p>Because we declared a <code>#[primary_key]</code> column in our <code>User</code> table, we can also register on-update callbacks. These run whenever a row is replaced by a row with the same primary key, like our module&#x27;s <code>ctx.db.user().identity().update(..)</code> calls. We register these callbacks using the <code>on_update</code> method of the trait <code>TableWithPrimaryKey</code>, which is automatically implemented by <code>spacetime generate</code> for any table with a <code>#[primary_key]</code> column.</p>
<p><code>on_update</code> callbacks take three arguments: the <code>&amp;EventContext</code>, the old row, and the new row.</p>
<p>In our module, users can be updated for three reasons:</p>
<ol>
<li>They&#x27;ve set their name using the <code>set_name</code> reducer.</li>
<li>They&#x27;re an existing user re-connecting, so their <code>online</code> has been set to <code>true</code>.</li>
<li>They&#x27;ve disconnected, so their <code>online</code> has been set to <code>false</code>.</li>
</ol>
<p>We&#x27;ll print an appropriate message in each of these cases.</p>
<p>To <code>client/src/main.rs</code>, add:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#6272A4">/// Our `User::on_update` callback:</span></span>
<span class="line"><span style="color:#6272A4">/// print a notification about name and status changes.</span></span>
<span class="line"><span style="color:#FF79C6">fn</span><span style="color:#50FA7B"> on_user_updated</span><span style="color:#F8F8F2">(_ctx</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">EventContext</span><span style="color:#F8F8F2">, old</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">User</span><span style="color:#F8F8F2">, new</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">User</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#FF79C6">    if</span><span style="color:#F8F8F2"> old</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">name </span><span style="color:#FF79C6">!=</span><span style="color:#F8F8F2"> new</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">name {</span></span>
<span class="line"><span style="color:#50FA7B">        println!</span><span style="color:#F8F8F2">(</span></span>
<span class="line"><span style="color:#F1FA8C">            &quot;User {} renamed to {}.&quot;</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#50FA7B">            user_name_or_identity</span><span style="color:#F8F8F2">(old),</span></span>
<span class="line"><span style="color:#50FA7B">            user_name_or_identity</span><span style="color:#F8F8F2">(new)</span></span>
<span class="line"><span style="color:#F8F8F2">        );</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#FF79C6">    if</span><span style="color:#F8F8F2"> old</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">online </span><span style="color:#FF79C6">&amp;&amp;</span><span style="color:#FF79C6"> !</span><span style="color:#F8F8F2">new</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">online {</span></span>
<span class="line"><span style="color:#50FA7B">        println!</span><span style="color:#F8F8F2">(</span><span style="color:#F1FA8C">&quot;User {} disconnected.&quot;</span><span style="color:#F8F8F2">, </span><span style="color:#50FA7B">user_name_or_identity</span><span style="color:#F8F8F2">(new));</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#FF79C6">    if</span><span style="color:#FF79C6"> !</span><span style="color:#F8F8F2">old</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">online </span><span style="color:#FF79C6">&amp;&amp;</span><span style="color:#F8F8F2"> new</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">online {</span></span>
<span class="line"><span style="color:#50FA7B">        println!</span><span style="color:#F8F8F2">(</span><span style="color:#F1FA8C">&quot;User {} connected.&quot;</span><span style="color:#F8F8F2">, </span><span style="color:#50FA7B">user_name_or_identity</span><span style="color:#F8F8F2">(new));</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<h3 class="anchor anchorWithStickyNavbar_wKCU" id="print-messages">Print messages<a href="#print-messages" class="hash-link" aria-label="Direct link to Print messages" title="Direct link to Print messages" translate="no">​</a></h3>
<p>When we receive a new message, we&#x27;ll print it to standard output, along with the name of the user who sent it. Keep in mind that we only want to do this for new messages, i.e. those inserted by a <code>send_message</code> reducer invocation. We have to handle the backlog we receive when our subscription is initialized separately, to ensure they&#x27;re printed in the correct order. To that effect, our <code>on_message_inserted</code> callback will check if the ctx.event type is an <code>Event::Reducer</code>, and only print in that case.</p>
<p>To find the <code>User</code> based on the message&#x27;s <code>sender</code> identity, we&#x27;ll use <code>ctx.db.user().identity().find(..)</code>, which behaves like the same function on the server.</p>
<p>We&#x27;ll print the user&#x27;s name or identity in the same way as we did when notifying about <code>User</code> table events, but here we have to handle the case where we don&#x27;t find a matching <code>User</code> row. This can happen when the module owner sends a message using the CLI&#x27;s <code>spacetime call</code>. In this case, we&#x27;ll print <code>unknown</code>.</p>
<p>Notice that our <code>print_message</code> function takes an <code>&amp;impl RemoteDbContext</code> as an argument. This is a trait, defined in our <code>module_bindings</code> by <code>spacetime generate</code>, which is implemented by <code>DbConnection</code>, <code>EventContext</code>, <code>ErrorContext</code> and a few other similar types. (<code>RemoteDbContext</code> is actually a shorthand for <code>DbContext</code>, which applies to connections to <em>any</em> module, with its associated types locked to module-specific ones.) Later on, we&#x27;re going to call <code>print_message</code> with a <code>ReducerEventContext</code>, so we need to be more generic than just accepting <code>EventContext</code>.</p>
<p>To <code>client/src/main.rs</code>, add:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#6272A4">/// Our `Message::on_insert` callback: print new messages.</span></span>
<span class="line"><span style="color:#FF79C6">fn</span><span style="color:#50FA7B"> on_message_inserted</span><span style="color:#F8F8F2">(ctx</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">EventContext</span><span style="color:#F8F8F2">, message</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">Message</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#FF79C6">    if</span><span style="color:#FF79C6"> let</span><span style="color:#8BE9FD;font-style:italic"> Event</span><span style="color:#FF79C6">::</span><span style="color:#50FA7B">Reducer</span><span style="color:#F8F8F2">(_) </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> ctx</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">event {</span></span>
<span class="line"><span style="color:#50FA7B">        print_message</span><span style="color:#F8F8F2">(ctx, message)</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">fn</span><span style="color:#50FA7B"> print_message</span><span style="color:#F8F8F2">(ctx</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;impl</span><span style="color:#8BE9FD;font-style:italic"> RemoteDbContext</span><span style="color:#F8F8F2">, message</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">Message</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> sender </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> ctx</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">db</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">user</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">identity</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">find</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">&amp;</span><span style="color:#F8F8F2">message</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">sender</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">clone</span><span style="color:#F8F8F2">())</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">map</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">|</span><span style="color:#F8F8F2">u</span><span style="color:#FF79C6">|</span><span style="color:#50FA7B"> user_name_or_identity</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">&amp;</span><span style="color:#F8F8F2">u))</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">unwrap_or_else</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">||</span><span style="color:#F1FA8C"> &quot;unknown&quot;</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">to_string</span><span style="color:#F8F8F2">());</span></span>
<span class="line"><span style="color:#50FA7B">    println!</span><span style="color:#F8F8F2">(</span><span style="color:#F1FA8C">&quot;{}: {}&quot;</span><span style="color:#F8F8F2">, sender, message</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">text);</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<h3 class="anchor anchorWithStickyNavbar_wKCU" id="handle-reducer-failures">Handle reducer failures<a href="#handle-reducer-failures" class="hash-link" aria-label="Direct link to Handle reducer failures" title="Direct link to Handle reducer failures" translate="no">​</a></h3>
<p>We can also register callbacks to run each time a reducer is invoked. We register these callbacks using the <code>on_reducer</code> method of the <code>Reducer</code> trait, which is automatically implemented for each reducer by <code>spacetime generate</code>.</p>
<p>Each reducer callback first takes a <code>&amp;ReducerEventContext</code> which contains metadata about the reducer call, including the identity of the caller and whether or not the reducer call suceeded.</p>
<p>These callbacks will be invoked in one of two cases:</p>
<ol>
<li>If the reducer was successful and altered any of our subscribed rows.</li>
<li>If we requested an invocation which failed.</li>
</ol>
<p>Note that a status of <code>Failed</code> or <code>OutOfEnergy</code> implies that the caller identity is our own identity.</p>
<p>We already handle successful <code>set_name</code> invocations using our <code>ctx.db.user().on_update(..)</code> callback, but if the module rejects a user&#x27;s chosen name, we&#x27;d like that user&#x27;s client to let them know. We define a function <code>on_set_name</code> as a <code>conn.reducers.on_set_name(..)</code> callback which checks if the reducer failed, and if it did, prints a message including the rejected name and the error.</p>
<p>To <code>client/src/main.rs</code>, add:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#6272A4">/// Our `on_set_name` callback: print a warning if the reducer failed.</span></span>
<span class="line"><span style="color:#FF79C6">fn</span><span style="color:#50FA7B"> on_name_set</span><span style="color:#F8F8F2">(ctx</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">ReducerEventContext</span><span style="color:#F8F8F2">, name</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">String</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#FF79C6">    if</span><span style="color:#FF79C6"> let</span><span style="color:#8BE9FD;font-style:italic"> Status</span><span style="color:#FF79C6">::</span><span style="color:#50FA7B">Failed</span><span style="color:#F8F8F2">(err) </span><span style="color:#FF79C6">=</span><span style="color:#FF79C6"> &amp;</span><span style="color:#F8F8F2">ctx</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">event</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">status {</span></span>
<span class="line"><span style="color:#50FA7B">        eprintln!</span><span style="color:#F8F8F2">(</span><span style="color:#F1FA8C">&quot;Failed to change name to {:?}: {}&quot;</span><span style="color:#F8F8F2">, name, err);</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">/// Our `on_send_message` callback: print a warning if the reducer failed.</span></span>
<span class="line"><span style="color:#FF79C6">fn</span><span style="color:#50FA7B"> on_message_sent</span><span style="color:#F8F8F2">(ctx</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">ReducerEventContext</span><span style="color:#F8F8F2">, text</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">String</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#FF79C6">    if</span><span style="color:#FF79C6"> let</span><span style="color:#8BE9FD;font-style:italic"> Status</span><span style="color:#FF79C6">::</span><span style="color:#50FA7B">Failed</span><span style="color:#F8F8F2">(err) </span><span style="color:#FF79C6">=</span><span style="color:#FF79C6"> &amp;</span><span style="color:#F8F8F2">ctx</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">event</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">status {</span></span>
<span class="line"><span style="color:#50FA7B">        eprintln!</span><span style="color:#F8F8F2">(</span><span style="color:#F1FA8C">&quot;Failed to send message {:?}: {}&quot;</span><span style="color:#F8F8F2">, text, err);</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<h2 class="anchor anchorWithStickyNavbar_wKCU" id="subscribe-to-queries">Subscribe to queries<a href="#subscribe-to-queries" class="hash-link" aria-label="Direct link to Subscribe to queries" title="Direct link to Subscribe to queries" translate="no">​</a></h2>
<p>SpacetimeDB is set up so that each client subscribes via SQL queries to some subset of the database, and is notified about changes only to that subset. For complex apps with large databases, judicious subscriptions can save each client significant network bandwidth, memory and computation. For example, in <a href="https://bitcraftonline.com" target="_blank" rel="noopener noreferrer">BitCraft</a>, each player&#x27;s client subscribes only to the entities in the &quot;chunk&quot; of the world where that player currently resides, rather than the entire game world. Our app is much simpler than BitCraft, so we&#x27;ll just subscribe to the whole database.</p>
<p>When we specify our subscriptions, we can supply an <code>on_applied</code> callback. This will run when the subscription is applied and the matching rows become available in our client cache. We&#x27;ll use this opportunity to print the message backlog in proper order.</p>
<p>We&#x27;ll also provide an <code>on_error</code> callback. This will run if the subscription fails, usually due to an invalid or malformed SQL queries. We can&#x27;t handle this case, so we&#x27;ll just print out the error and exit the process.</p>
<p>To <code>client/src/main.rs</code>, add:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#6272A4">/// Register subscriptions for all rows of both tables.</span></span>
<span class="line"><span style="color:#FF79C6">fn</span><span style="color:#50FA7B"> subscribe_to_tables</span><span style="color:#F8F8F2">(ctx</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">DbConnection</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#F8F8F2">    ctx</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">subscription_builder</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">on_applied</span><span style="color:#F8F8F2">(on_sub_applied)</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">on_error</span><span style="color:#F8F8F2">(on_sub_error)</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">subscribe</span><span style="color:#F8F8F2">([</span><span style="color:#F1FA8C">&quot;SELECT * FROM user&quot;</span><span style="color:#F8F8F2">, </span><span style="color:#F1FA8C">&quot;SELECT * FROM message&quot;</span><span style="color:#F8F8F2">]);</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<h3 class="anchor anchorWithStickyNavbar_wKCU" id="print-past-messages-in-order">Print past messages in order<a href="#print-past-messages-in-order" class="hash-link" aria-label="Direct link to Print past messages in order" title="Direct link to Print past messages in order" translate="no">​</a></h3>
<p>Messages we receive live will come in order, but when we connect, we&#x27;ll receive all the past messages at once. We can&#x27;t just print these in the order we receive them; the logs would be all shuffled around, and would make no sense. Instead, when we receive the log of past messages, we&#x27;ll sort them by their sent timestamps and print them in order.</p>
<p>We&#x27;ll handle this in our function <code>print_messages_in_order</code>, which we registered as an <code>on_applied</code> callback. <code>print_messages_in_order</code> iterates over all the <code>Message</code>s we&#x27;ve received, sorts them, and then prints them. <code>ctx.db.message().iter()</code> is defined on the trait <code>Table</code>, and returns an iterator over all the messages in the client cache. Rust iterators can&#x27;t be sorted in-place, so we&#x27;ll collect it to a <code>Vec</code>, then use the <code>sort_by_key</code> method to sort by timestamp.</p>
<p>To <code>client/src/main.rs</code>, add:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#6272A4">/// Our `on_subscription_applied` callback:</span></span>
<span class="line"><span style="color:#6272A4">/// sort all past messages and print them in timestamp order.</span></span>
<span class="line"><span style="color:#FF79C6">fn</span><span style="color:#50FA7B"> on_sub_applied</span><span style="color:#F8F8F2">(ctx</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">SubscriptionEventContext</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#FF79C6"> mut</span><span style="color:#F8F8F2"> messages </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> ctx</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">db</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">message</span><span style="color:#F8F8F2">()</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">iter</span><span style="color:#F8F8F2">()</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">collect</span><span style="color:#FF79C6">::</span><span style="color:#F8F8F2">&lt;</span><span style="color:#8BE9FD;font-style:italic">Vec</span><span style="color:#F8F8F2">&lt;_&gt;&gt;();</span></span>
<span class="line"><span style="color:#F8F8F2">    messages</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">sort_by_key</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">|</span><span style="color:#F8F8F2">m</span><span style="color:#FF79C6">|</span><span style="color:#F8F8F2"> m</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">sent);</span></span>
<span class="line"><span style="color:#FF79C6">    for</span><span style="color:#F8F8F2"> message </span><span style="color:#FF79C6">in</span><span style="color:#F8F8F2"> messages {</span></span>
<span class="line"><span style="color:#50FA7B">        print_message</span><span style="color:#F8F8F2">(ctx, </span><span style="color:#FF79C6">&amp;</span><span style="color:#F8F8F2">message);</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#50FA7B">    println!</span><span style="color:#F8F8F2">(</span><span style="color:#F1FA8C">&quot;Fully connected and all subscriptions applied.&quot;</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#50FA7B">    println!</span><span style="color:#F8F8F2">(</span><span style="color:#F1FA8C">&quot;Use /name to set your name, or type a message!&quot;</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<h3 class="anchor anchorWithStickyNavbar_wKCU" id="notify-about-failed-subscriptions">Notify about failed subscriptions<a href="#notify-about-failed-subscriptions" class="hash-link" aria-label="Direct link to Notify about failed subscriptions" title="Direct link to Notify about failed subscriptions" translate="no">​</a></h3>
<p>It&#x27;s possible for SpacetimeDB to reject subscriptions. This happens most often because of a typo in the SQL queries, but can be due to use of SQL features that SpacetimeDB doesn&#x27;t support. See <a href="/sql#subscriptions">SQL Support: Subscriptions</a> for more information about what subscription queries SpacetimeDB supports.</p>
<p>In our case, we&#x27;re pretty confident that our queries are valid, but if SpacetimeDB rejects them, we want to know about it. Our callback will print the error, then exit the process.</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#6272A4">/// Or `on_error` callback:</span></span>
<span class="line"><span style="color:#6272A4">/// print the error, then exit the process.</span></span>
<span class="line"><span style="color:#FF79C6">fn</span><span style="color:#50FA7B"> on_sub_error</span><span style="color:#F8F8F2">(_ctx</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">ErrorContext</span><span style="color:#F8F8F2">, err</span><span style="color:#FF79C6">:</span><span style="color:#8BE9FD;font-style:italic"> Error</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#50FA7B">    eprintln!</span><span style="color:#F8F8F2">(</span><span style="color:#F1FA8C">&quot;Subscription failed: {}&quot;</span><span style="color:#F8F8F2">, err);</span></span>
<span class="line"><span style="color:#F8F8F2">    std</span><span style="color:#FF79C6">::</span><span style="color:#F8F8F2">process</span><span style="color:#FF79C6">::</span><span style="color:#50FA7B">exit</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<h2 class="anchor anchorWithStickyNavbar_wKCU" id="handle-user-input">Handle user input<a href="#handle-user-input" class="hash-link" aria-label="Direct link to Handle user input" title="Direct link to Handle user input" translate="no">​</a></h2>
<p>Our app should allow the user to interact by typing lines into their terminal. If the line starts with <code>/name</code>, we&#x27;ll change the user&#x27;s name. Any other line will send a message.</p>
<p>For each reducer defined by our module, <code>ctx.reducers</code> has a method to request an invocation. In our case, we pass <code>set_name</code> and <code>send_message</code> a <code>String</code>, which gets sent to the server to execute the corresponding reducer.</p>
<p>To <code>client/src/main.rs</code>, add:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#6272A4">/// Read each line of standard input, and either set our name or send a message as appropriate.</span></span>
<span class="line"><span style="color:#FF79C6">fn</span><span style="color:#50FA7B"> user_input_loop</span><span style="color:#F8F8F2">(ctx</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">DbConnection</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#FF79C6">    for</span><span style="color:#F8F8F2"> line </span><span style="color:#FF79C6">in</span><span style="color:#F8F8F2"> std</span><span style="color:#FF79C6">::</span><span style="color:#F8F8F2">io</span><span style="color:#FF79C6">::</span><span style="color:#50FA7B">stdin</span><span style="color:#F8F8F2">()</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">lines</span><span style="color:#F8F8F2">() {</span></span>
<span class="line"><span style="color:#FF79C6">        let</span><span style="color:#8BE9FD;font-style:italic"> Ok</span><span style="color:#F8F8F2">(line) </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> line </span><span style="color:#FF79C6">else</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#50FA7B">            panic!</span><span style="color:#F8F8F2">(</span><span style="color:#F1FA8C">&quot;Failed to read from stdin.&quot;</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">        };</span></span>
<span class="line"><span style="color:#FF79C6">        if</span><span style="color:#FF79C6"> let</span><span style="color:#8BE9FD;font-style:italic"> Some</span><span style="color:#F8F8F2">(name) </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> line</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">strip_prefix</span><span style="color:#F8F8F2">(</span><span style="color:#F1FA8C">&quot;/name &quot;</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#F8F8F2">            ctx</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">reducers</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">set_name</span><span style="color:#F8F8F2">(name</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">to_string</span><span style="color:#F8F8F2">())</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">unwrap</span><span style="color:#F8F8F2">();</span></span>
<span class="line"><span style="color:#F8F8F2">        } </span><span style="color:#FF79C6">else</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#F8F8F2">            ctx</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">reducers</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">send_message</span><span style="color:#F8F8F2">(line)</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">unwrap</span><span style="color:#F8F8F2">();</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<h2 class="anchor anchorWithStickyNavbar_wKCU" id="run-it">Run it<a href="#run-it" class="hash-link" aria-label="Direct link to Run it" title="Direct link to Run it" translate="no">​</a></h2>
<p>After setting everything up, change your directory to the client app, then compile and run it. From the <code>quickstart-chat</code> directory, run:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#8BE9FD">cd</span><span style="color:#F1FA8C"> client</span></span>
<span class="line"><span style="color:#50FA7B">cargo</span><span style="color:#F1FA8C"> run</span></span></code></pre>
<p>You should see something like:</p>
<div class="language-text codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_p1l2"><pre tabindex="0" class="prism-code language-text codeBlock_qbrE thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="token-line" style="color:#bfc7d5"><span class="token plain">User d9e25c51996dea2f connected.</span><br></span></code></pre></div></div>
<p>Now try sending a message by typing <code>Hello, world!</code> and pressing enter. You should see:</p>
<div class="language-text codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_p1l2"><pre tabindex="0" class="prism-code language-text codeBlock_qbrE thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="token-line" style="color:#bfc7d5"><span class="token plain">d9e25c51996dea2f: Hello, world!</span><br></span></code></pre></div></div>
<p>Next, set your name by typing <code>/name &lt;my-name&gt;</code>, replacing <code>&lt;my-name&gt;</code> with your desired username. You should see:</p>
<div class="language-text codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_p1l2"><pre tabindex="0" class="prism-code language-text codeBlock_qbrE thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="token-line" style="color:#bfc7d5"><span class="token plain">User d9e25c51996dea2f renamed to &lt;my-name&gt;.</span><br></span></code></pre></div></div>
<p>Then, send another message:</p>
<div class="language-text codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_p1l2"><pre tabindex="0" class="prism-code language-text codeBlock_qbrE thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;my-name&gt;: Hello after naming myself.</span><br></span></code></pre></div></div>
<p>Now, close the app by hitting <code>Ctrl+C</code>, and start it again with <code>cargo run</code>. You&#x27;ll see yourself connecting, and your past messages will load in order:</p>
<div class="language-text codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_p1l2"><pre tabindex="0" class="prism-code language-text codeBlock_qbrE thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="token-line" style="color:#bfc7d5"><span class="token plain">User &lt;my-name&gt; connected.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;my-name&gt;: Hello, world!</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;my-name&gt;: Hello after naming myself.</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_wKCU" id="whats-next">What&#x27;s next?<a href="#whats-next" class="hash-link" aria-label="Direct link to What&#x27;s next?" title="Direct link to What&#x27;s next?" translate="no">​</a></h2>
<p>You can find the full code for this client <a href="https://github.com/clockworklabs/SpacetimeDB/tree/master/crates/sdk/examples/quickstart-chat" target="_blank" rel="noopener noreferrer">in the Rust client SDK&#x27;s examples</a>.</p>
<p>Check out the <a href="/sdks/rust">Rust client SDK Reference</a> for a more comprehensive view of the SpacetimeDB Rust client SDK.</p>
<p>Our basic terminal interface has some limitations. Incoming messages can appear while the user is typing, which is less than ideal. Additionally, the user&#x27;s input gets mixed with the program&#x27;s output, making messages the user sends appear twice. You might want to try improving the interface by using <a href="https://crates.io/crates/rustyline" target="_blank" rel="noopener noreferrer">Rustyline</a>, <a href="https://crates.io/crates/cursive" target="_blank" rel="noopener noreferrer">Cursive</a>, or even creating a full-fledged GUI.</p>
<p>Once your chat server runs for a while, you might want to limit the messages your client loads by refining your <code>Message</code> subscription query, only subscribing to messages sent within the last half-hour.</p>
<p>You could also add features like:</p>
<ul>
<li>Styling messages by interpreting HTML tags and printing appropriate <a href="https://en.wikipedia.org/wiki/ANSI_escape_code" target="_blank" rel="noopener noreferrer">ANSI escapes</a>.</li>
<li>Adding a <code>moderator</code> flag to the <code>User</code> table, allowing moderators to manage users (e.g., time-out, ban).</li>
<li>Adding rooms or channels that users can join or leave.</li>
<li>Supporting direct messages or displaying user statuses next to their usernames.</li>
</ul></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/sdks/c-sharp"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">C# Reference</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/sdks/rust"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Rust Reference</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_Ea_L thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#project-structure" class="table-of-contents__link toc-highlight">Project structure</a></li><li><a href="#depend-on-spacetimedb-sdk-and-hex" class="table-of-contents__link toc-highlight">Depend on <code>spacetimedb-sdk</code> and <code>hex</code></a></li><li><a href="#clear-clientsrcmainrs" class="table-of-contents__link toc-highlight">Clear <code>client/src/main.rs</code></a></li><li><a href="#generate-your-module-types" class="table-of-contents__link toc-highlight">Generate your module types</a></li><li><a href="#add-more-imports" class="table-of-contents__link toc-highlight">Add more imports</a></li><li><a href="#define-the-main-function" class="table-of-contents__link toc-highlight">Define the main function</a></li><li><a href="#connect-to-the-database" class="table-of-contents__link toc-highlight">Connect to the database</a><ul><li><a href="#save-credentials" class="table-of-contents__link toc-highlight">Save credentials</a></li><li><a href="#handle-errors-and-disconnections" class="table-of-contents__link toc-highlight">Handle errors and disconnections</a></li></ul></li><li><a href="#register-callbacks" class="table-of-contents__link toc-highlight">Register callbacks</a><ul><li><a href="#notify-about-new-users" class="table-of-contents__link toc-highlight">Notify about new users</a></li><li><a href="#notify-about-updated-users" class="table-of-contents__link toc-highlight">Notify about updated users</a></li><li><a href="#print-messages" class="table-of-contents__link toc-highlight">Print messages</a></li><li><a href="#handle-reducer-failures" class="table-of-contents__link toc-highlight">Handle reducer failures</a></li></ul></li><li><a href="#subscribe-to-queries" class="table-of-contents__link toc-highlight">Subscribe to queries</a><ul><li><a href="#print-past-messages-in-order" class="table-of-contents__link toc-highlight">Print past messages in order</a></li><li><a href="#notify-about-failed-subscriptions" class="table-of-contents__link toc-highlight">Notify about failed subscriptions</a></li></ul></li><li><a href="#handle-user-input" class="table-of-contents__link toc-highlight">Handle user input</a></li><li><a href="#run-it" class="table-of-contents__link toc-highlight">Run it</a></li><li><a href="#whats-next" class="table-of-contents__link toc-highlight">What&#39;s next?</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer"><div class="container container-fluid"></div></footer></div>
</body>
</html>