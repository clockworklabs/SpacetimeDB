<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-How-To/Incremental-Migrations" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.1">
<title data-rh="true">Incremental Migrations | SpacetimeDB docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.spacetimedb.com/how-to/incremental-migrations"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Incremental Migrations | SpacetimeDB docs"><meta data-rh="true" name="description" content="SpacetimeDB does not provide built-in support for general schema-modifying migrations. It does, however, allow adding new tables, and changing reducers&#x27; definitions in arbitrary ways. It&#x27;s possible to run general migrations using an external tool, but this is tedious, necessitates downtime, and imposes the requirement that you update all your clients at the same time as publishing your new module version."><meta data-rh="true" property="og:description" content="SpacetimeDB does not provide built-in support for general schema-modifying migrations. It does, however, allow adding new tables, and changing reducers&#x27; definitions in arbitrary ways. It&#x27;s possible to run general migrations using an external tool, but this is tedious, necessitates downtime, and imposes the requirement that you update all your clients at the same time as publishing your new module version."><link data-rh="true" rel="icon" href="/images/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.spacetimedb.com/how-to/incremental-migrations"><link data-rh="true" rel="alternate" href="https://docs.spacetimedb.com/how-to/incremental-migrations" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.spacetimedb.com/how-to/incremental-migrations" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://QBC7Z9KXS2-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Incremental Migrations","item":"https://docs.spacetimedb.com/how-to/incremental-migrations"}]}</script><link rel="search" type="application/opensearchdescription+xml" title="SpacetimeDB docs" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.0cb9f7a7.css">
<script src="/assets/js/runtime~main.d71df0f5.js" defer="defer"></script>
<script src="/assets/js/main.31d95d83.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>document.documentElement.setAttribute("data-theme","light"),document.documentElement.setAttribute("data-theme-choice","light"),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="https://spacetimedb.com/images/brand.png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_6jFv" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="https://spacetimedb.com/images/brand.png" alt="SpacetimeDB Logo" class="themedComponent_rvet themedComponent--light_mbAJ"><img src="https://spacetimedb.com/images/brand.png" alt="SpacetimeDB Logo" class="themedComponent_rvet themedComponent--dark_Ncy6"></div></a><div class="navbarSearchContainer_AesG"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://spacetimedb.com/install" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Install</a><a href="https://spacetimedb.com/pricing" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Pricing</a><a href="https://spacetimedb.com/maincloud" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Maincloud</a><a href="https://spacetimedb.com/blog" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Blog</a><a href="https://spacetimedb.com/community" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Community</a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_hV_y"><div class="docsWrapper_f07g"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_MJiz" type="button"></button><div class="docRoot_Gd2s"><aside class="theme-doc-sidebar-container docSidebarContainer_fSpF"><div class="sidebarViewport_YElg"><div class="sidebar_kjg4"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_AG0n"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/"><span title="Intro" class="categoryLinkLabel_EDYQ">Intro</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/deploying/maincloud"><span title="Deploying" class="categoryLinkLabel_EDYQ">Deploying</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/unity"><span title="Unity tutorial" class="categoryLinkLabel_EDYQ">Unity tutorial</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/unreal"><span title="Unreal Tutorial" class="categoryLinkLabel_EDYQ">Unreal Tutorial</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/cli-reference"><span title="CLI Reference" class="categoryLinkLabel_EDYQ">CLI Reference</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/modules"><span title="Server Module Languages" class="categoryLinkLabel_EDYQ">Server Module Languages</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/sdks"><span title="Client SDK Languages" class="categoryLinkLabel_EDYQ">Client SDK Languages</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/sql"><span title="SQL" class="categoryLinkLabel_EDYQ">SQL</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/subscriptions"><span title="Subscriptions" class="categoryLinkLabel_EDYQ">Subscriptions</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/rls"><span title="Row Level Security" class="linkLabel_dpMB">Row Level Security</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/how-to/incremental-migrations"><span title="How-To" class="categoryLinkLabel_EDYQ">How-To</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/how-to/incremental-migrations"><span title="Incremental Migrations" class="linkLabel_dpMB">Incremental Migrations</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/how-to/reject-client-connections"><span title="Reject Client Connections" class="linkLabel_dpMB">Reject Client Connections</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/spacetimeauth"><span title="SpacetimeAuth" class="categoryLinkLabel_EDYQ">SpacetimeAuth</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/http/authorization"><span title="HTTP API" class="categoryLinkLabel_EDYQ">HTTP API</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ggI5 menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/webassembly-abi"><span title="Internals" class="categoryLinkLabel_EDYQ">Internals</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/appendix"><span title="Appendix" class="linkLabel_dpMB">Appendix</span></a></li></ul></nav></div></div></aside><main class="docMainContainer_dkUT"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_w2oE"><div class="docItemContainer_f71m"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_xsLZ" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_oyay"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">How-To</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Incremental Migrations</span></li></ul></nav><div class="theme-doc-markdown markdown"><header><h1>Incremental Migrations</h1></header>
<p>SpacetimeDB does not provide built-in support for general schema-modifying migrations. It does, however, allow adding new tables, and changing reducers&#x27; definitions in arbitrary ways. It&#x27;s possible to run general migrations using an external tool, but this is tedious, necessitates downtime, and imposes the requirement that you update all your clients at the same time as publishing your new module version.</p>
<p>Our friends at <a href="https://www.lightfoxgames.com/" target="_blank" rel="noopener noreferrer">Lightfox Games</a> taught us a pattern they call &quot;incremental migrations,&quot; which mitigates all these problems, and works perfectly with SpacetimeDB&#x27;s capabilities. The short version is that, instead of altering an existing table, you add a new table with the desired new schema. Whenever your module wants to access a row from that table, it first checks the new table. If the row is present in the new table, then you&#x27;ve already migrated, so do whatever you want to do. If the new table doesn&#x27;t have the row, instead look it up in the old table, compute and insert a row for the new table, and use that. (If the row isn&#x27;t present in either the old or new table, it&#x27;s just not present.) If possible, you should also update the row in the old table to match any mutations that happen in the new table, so that outdated clients can still function.</p>
<p>This has several advantages:</p>
<ul>
<li>SpacetimeDB&#x27;s module hotswapping makes this a zero-downtime update. Write your new module, <code>spacetime publish</code> it, and watch the new table populate as it&#x27;s used.</li>
<li>It amortizes the cost of transforming rows or computing new columns across many transactions. Rows will only be added to the new table when they&#x27;re needed.</li>
<li>In many cases, old clients from before the update can coexist with new clients that use the new table. You can publish the updated module without disconnecting your clients, roll out the client update through normal channels, and allow your users to update at their own pace.</li>
</ul>
<p>For example, imagine we have a table <code>player</code> which stores information about our players:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#F8F8F2">#[spacetimedb</span><span style="color:#FF79C6">::</span><span style="color:#F8F8F2">table(name </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> character, public)]</span></span>
<span class="line"><span style="color:#FF79C6">pub</span><span style="color:#FF79C6"> struct</span><span style="color:#8BE9FD;font-style:italic"> Character</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#F8F8F2">    #[primary_key]</span></span>
<span class="line"><span style="color:#F8F8F2">    player_id</span><span style="color:#FF79C6">:</span><span style="color:#8BE9FD;font-style:italic"> Identity</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">    #[unique]</span></span>
<span class="line"><span style="color:#F8F8F2">    nickname</span><span style="color:#FF79C6">:</span><span style="color:#8BE9FD;font-style:italic"> String</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">    level</span><span style="color:#FF79C6">:</span><span style="color:#8BE9FD;font-style:italic"> u32</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">    class</span><span style="color:#FF79C6">:</span><span style="color:#8BE9FD;font-style:italic"> Class</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">#[derive(</span><span style="color:#8BE9FD;font-style:italic">SpacetimeType</span><span style="color:#F8F8F2">, </span><span style="color:#8BE9FD;font-style:italic">Debug</span><span style="color:#F8F8F2">, </span><span style="color:#8BE9FD;font-style:italic">Copy</span><span style="color:#F8F8F2">, </span><span style="color:#8BE9FD;font-style:italic">Clone</span><span style="color:#F8F8F2">)]</span></span>
<span class="line"><span style="color:#FF79C6">pub</span><span style="color:#FF79C6"> enum</span><span style="color:#8BE9FD;font-style:italic"> Class</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#8BE9FD;font-style:italic">    Fighter</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#8BE9FD;font-style:italic">    Caster</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#8BE9FD;font-style:italic">    Medic</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<p>We&#x27;ll write a few helper functions and some simple reducers:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#F8F8F2">#[spacetimedb</span><span style="color:#FF79C6">::</span><span style="color:#F8F8F2">reducer]</span></span>
<span class="line"><span style="color:#FF79C6">fn</span><span style="color:#50FA7B"> create_character</span><span style="color:#F8F8F2">(ctx</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">ReducerContext</span><span style="color:#F8F8F2">, class</span><span style="color:#FF79C6">:</span><span style="color:#8BE9FD;font-style:italic"> Class</span><span style="color:#F8F8F2">, nickname</span><span style="color:#FF79C6">:</span><span style="color:#8BE9FD;font-style:italic"> String</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#F8F8F2">    log</span><span style="color:#FF79C6">::</span><span style="color:#50FA7B">info!</span><span style="color:#F8F8F2">(</span></span>
<span class="line"><span style="color:#F1FA8C">        &quot;Creating new level 1 {class:?} named {nickname}&quot;</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">    );</span></span>
<span class="line"><span style="color:#F8F8F2">    ctx</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">db</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">character</span><span style="color:#F8F8F2">()</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">insert</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD;font-style:italic">Character</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#F8F8F2">        player_id</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> ctx</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">sender,</span></span>
<span class="line"><span style="color:#F8F8F2">        nickname,</span></span>
<span class="line"><span style="color:#F8F8F2">        level</span><span style="color:#FF79C6">:</span><span style="color:#BD93F9"> 1</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">        class,</span></span>
<span class="line"><span style="color:#F8F8F2">    });</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">fn</span><span style="color:#50FA7B"> find_character_for_player</span><span style="color:#F8F8F2">(ctx</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">ReducerContext</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">-&gt;</span><span style="color:#8BE9FD;font-style:italic"> Character</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#F8F8F2">    ctx</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">db</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">character</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">player_id</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">find</span><span style="color:#F8F8F2">(ctx</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">sender)</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">expect</span><span style="color:#F8F8F2">(</span><span style="color:#F1FA8C">&quot;Player has not created a character&quot;</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">fn</span><span style="color:#50FA7B"> update_character</span><span style="color:#F8F8F2">(ctx</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">ReducerContext</span><span style="color:#F8F8F2">, character</span><span style="color:#FF79C6">:</span><span style="color:#8BE9FD;font-style:italic"> Character</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#F8F8F2">    ctx</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">db</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">character</span><span style="color:#F8F8F2">()</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">player_id</span><span style="color:#F8F8F2">()</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">update</span><span style="color:#F8F8F2">(character);</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">#[spacetimedb</span><span style="color:#FF79C6">::</span><span style="color:#F8F8F2">reducer]</span></span>
<span class="line"><span style="color:#FF79C6">fn</span><span style="color:#50FA7B"> rename_character</span><span style="color:#F8F8F2">(ctx</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">ReducerContext</span><span style="color:#F8F8F2">, new_name</span><span style="color:#FF79C6">:</span><span style="color:#8BE9FD;font-style:italic"> String</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> character </span><span style="color:#FF79C6">=</span><span style="color:#50FA7B"> find_character_for_player</span><span style="color:#F8F8F2">(ctx);</span></span>
<span class="line"><span style="color:#F8F8F2">    log</span><span style="color:#FF79C6">::</span><span style="color:#50FA7B">info!</span><span style="color:#F8F8F2">(</span></span>
<span class="line"><span style="color:#F1FA8C">        &quot;Renaming {} to {}&quot;</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">        character</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">nickname,</span></span>
<span class="line"><span style="color:#F8F8F2">        new_name,</span></span>
<span class="line"><span style="color:#F8F8F2">    );</span></span>
<span class="line"><span style="color:#50FA7B">    update_character</span><span style="color:#F8F8F2">(</span></span>
<span class="line"><span style="color:#F8F8F2">        ctx,</span></span>
<span class="line"><span style="color:#8BE9FD;font-style:italic">        Character</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#F8F8F2">            nickname</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> new_name,</span></span>
<span class="line"><span style="color:#FF79C6">            ..</span><span style="color:#F8F8F2">character</span></span>
<span class="line"><span style="color:#F8F8F2">        },</span></span>
<span class="line"><span style="color:#F8F8F2">    );</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">#[spacetimedb</span><span style="color:#FF79C6">::</span><span style="color:#F8F8F2">reducer]</span></span>
<span class="line"><span style="color:#FF79C6">fn</span><span style="color:#50FA7B"> level_up_character</span><span style="color:#F8F8F2">(ctx</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">ReducerContext</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> character </span><span style="color:#FF79C6">=</span><span style="color:#50FA7B"> find_character_for_player</span><span style="color:#F8F8F2">(ctx);</span></span>
<span class="line"><span style="color:#F8F8F2">    log</span><span style="color:#FF79C6">::</span><span style="color:#50FA7B">info!</span><span style="color:#F8F8F2">(</span></span>
<span class="line"><span style="color:#F1FA8C">        &quot;Leveling up {} from {} to {}&quot;</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">        character</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">nickname,</span></span>
<span class="line"><span style="color:#F8F8F2">        character</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">level,</span></span>
<span class="line"><span style="color:#F8F8F2">        character</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">level </span><span style="color:#FF79C6">+</span><span style="color:#BD93F9"> 1</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">    );</span></span>
<span class="line"><span style="color:#50FA7B">    update_character</span><span style="color:#F8F8F2">(</span></span>
<span class="line"><span style="color:#F8F8F2">        ctx,</span></span>
<span class="line"><span style="color:#8BE9FD;font-style:italic">        Character</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#F8F8F2">            level</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> character</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">level </span><span style="color:#FF79C6">+</span><span style="color:#BD93F9"> 1</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#FF79C6">            ..</span><span style="color:#F8F8F2">character</span></span>
<span class="line"><span style="color:#F8F8F2">        },</span></span>
<span class="line"><span style="color:#F8F8F2">    );</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<p>We&#x27;ll play around a bit with <code>spacetime call</code> to set up a character:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#50FA7B">$</span><span style="color:#F1FA8C"> spacetime</span><span style="color:#F1FA8C"> logs</span><span style="color:#F1FA8C"> incr-migration-demo</span><span style="color:#BD93F9"> -f</span><span style="color:#F8F8F2"> &amp;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#50FA7B">$</span><span style="color:#F1FA8C"> spacetime</span><span style="color:#F1FA8C"> call</span><span style="color:#F1FA8C"> incr-migration-demo</span><span style="color:#F1FA8C"> create_character</span><span style="color:#E9F284"> &#x27;</span><span style="color:#F1FA8C">{ &quot;Fighter&quot;: {} }</span><span style="color:#E9F284">&#x27;</span><span style="color:#E9F284"> &quot;</span><span style="color:#F1FA8C">Phoebe</span><span style="color:#E9F284">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#50FA7B">2025-01-07T15:32:57.447286Z</span><span style="color:#F1FA8C">  INFO:</span><span style="color:#F1FA8C"> src/lib.rs:21:</span><span style="color:#F1FA8C"> Creating</span><span style="color:#F1FA8C"> new</span><span style="color:#F1FA8C"> level</span><span style="color:#BD93F9"> 1</span><span style="color:#F1FA8C"> Fighter</span><span style="color:#F1FA8C"> named</span><span style="color:#F1FA8C"> Phoebe</span></span>
<span class="line"></span>
<span class="line"><span style="color:#50FA7B">$</span><span style="color:#F1FA8C"> spacetime</span><span style="color:#F1FA8C"> call</span><span style="color:#BD93F9"> -s</span><span style="color:#F1FA8C"> local</span><span style="color:#F1FA8C"> incr-migration-demo</span><span style="color:#F1FA8C"> rename_character</span><span style="color:#E9F284"> &quot;</span><span style="color:#F1FA8C">Gefjon</span><span style="color:#E9F284">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#50FA7B">2025-01-07T15:33:48.966134Z</span><span style="color:#F1FA8C">  INFO:</span><span style="color:#F1FA8C"> src/lib.rs:48:</span><span style="color:#F1FA8C"> Renaming</span><span style="color:#F1FA8C"> Phoebe</span><span style="color:#F1FA8C"> to</span><span style="color:#F1FA8C"> Gefjon</span></span>
<span class="line"></span>
<span class="line"><span style="color:#50FA7B">$</span><span style="color:#F1FA8C"> spacetime</span><span style="color:#F1FA8C"> call</span><span style="color:#BD93F9"> -s</span><span style="color:#F1FA8C"> local</span><span style="color:#F1FA8C"> incr-migration-demo</span><span style="color:#F1FA8C"> level_up_character</span></span>
<span class="line"></span>
<span class="line"><span style="color:#50FA7B">2025-01-07T15:34:01.437495Z</span><span style="color:#F1FA8C">  INFO:</span><span style="color:#F1FA8C"> src/lib.rs:66:</span><span style="color:#F1FA8C"> Leveling</span><span style="color:#F1FA8C"> up</span><span style="color:#F1FA8C"> Gefjon</span><span style="color:#F1FA8C"> from</span><span style="color:#BD93F9"> 1</span><span style="color:#F1FA8C"> to</span><span style="color:#BD93F9"> 2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#50FA7B">$</span><span style="color:#F1FA8C"> spacetime</span><span style="color:#F1FA8C"> sql</span><span style="color:#F1FA8C"> incr-migration-demo</span><span style="color:#E9F284"> &#x27;</span><span style="color:#F1FA8C">SELECT * FROM character</span><span style="color:#E9F284">&#x27;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#50FA7B"> player_id</span><span style="color:#FF79C6"> |</span><span style="color:#50FA7B"> nickname</span><span style="color:#FF79C6"> |</span><span style="color:#50FA7B"> level</span><span style="color:#FF79C6"> |</span><span style="color:#50FA7B"> class</span></span>
<span class="line"><span style="color:#50FA7B">-----------+----------+-------+----------------</span></span>
<span class="line"><span style="color:#FF79C6"> &lt;</span><span style="color:#50FA7B">snip</span><span style="color:#F8F8F2">&gt;    </span><span style="color:#FF79C6">|</span><span style="color:#50FA7B"> &quot;Gefjon&quot;</span><span style="color:#FF79C6"> |</span><span style="color:#50FA7B"> 2</span><span style="color:#FF79C6">     |</span><span style="color:#F8F8F2"> (</span><span style="color:#50FA7B">Fighter</span><span style="color:#F1FA8C"> =</span><span style="color:#F8F8F2"> ())</span></span></code></pre>
<p>See <a href="/sats-json">the SATS JSON reference</a> for more on the encoding of arguments to <code>spacetime call</code>.</p>
<p>Now we want to add a new feature: each player should be able to align themselves with the forces of good or evil, so we can get some healthy competition going between our players. We&#x27;ll start each character off with <code>Alliance::Neutral</code>, and then offer them a reducer <code>choose_alliance</code> to set it to either <code>Alliance::Good</code> or <code>Alliance::Evil</code>. Our first attempt will be to add a new column to the type <code>Character</code>:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#F8F8F2">#[spacetimedb</span><span style="color:#FF79C6">::</span><span style="color:#F8F8F2">table(name </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> character, public)]</span></span>
<span class="line"><span style="color:#FF79C6">struct</span><span style="color:#8BE9FD;font-style:italic"> Character</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#F8F8F2">    #[primary_key]</span></span>
<span class="line"><span style="color:#F8F8F2">    player_id</span><span style="color:#FF79C6">:</span><span style="color:#8BE9FD;font-style:italic"> Identity</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">    nickname</span><span style="color:#FF79C6">:</span><span style="color:#8BE9FD;font-style:italic"> String</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">    level</span><span style="color:#FF79C6">:</span><span style="color:#8BE9FD;font-style:italic"> u32</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">    class</span><span style="color:#FF79C6">:</span><span style="color:#8BE9FD;font-style:italic"> Class</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">    alliance</span><span style="color:#FF79C6">:</span><span style="color:#8BE9FD;font-style:italic"> Alliance</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">#[derive(</span><span style="color:#8BE9FD;font-style:italic">SpacetimeType</span><span style="color:#F8F8F2">, </span><span style="color:#8BE9FD;font-style:italic">Debug</span><span style="color:#F8F8F2">, </span><span style="color:#8BE9FD;font-style:italic">Copy</span><span style="color:#F8F8F2">, </span><span style="color:#8BE9FD;font-style:italic">Clone</span><span style="color:#F8F8F2">)]</span></span>
<span class="line"><span style="color:#FF79C6">enum</span><span style="color:#8BE9FD;font-style:italic"> Alliance</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#8BE9FD;font-style:italic">    Good</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#8BE9FD;font-style:italic">    Neutral</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#8BE9FD;font-style:italic">    Evil</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">#[spacetimedb</span><span style="color:#FF79C6">::</span><span style="color:#F8F8F2">reducer]</span></span>
<span class="line"><span style="color:#FF79C6">fn</span><span style="color:#50FA7B"> choose_alliance</span><span style="color:#F8F8F2">(ctx</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">ReducerContext</span><span style="color:#F8F8F2">, alliance</span><span style="color:#FF79C6">:</span><span style="color:#8BE9FD;font-style:italic"> Alliance</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> character </span><span style="color:#FF79C6">=</span><span style="color:#50FA7B"> find_character_for_player</span><span style="color:#F8F8F2">(ctx);</span></span>
<span class="line"><span style="color:#F8F8F2">    log</span><span style="color:#FF79C6">::</span><span style="color:#50FA7B">info!</span><span style="color:#F8F8F2">(</span></span>
<span class="line"><span style="color:#F1FA8C">        &quot;Setting {}&#x27;s alliance to {:?} for player {}&quot;</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">        character</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">nickname,</span></span>
<span class="line"><span style="color:#F8F8F2">        alliance,</span></span>
<span class="line"><span style="color:#F8F8F2">        ctx</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">sender,</span></span>
<span class="line"><span style="color:#F8F8F2">    );</span></span>
<span class="line"><span style="color:#50FA7B">    update_character</span><span style="color:#F8F8F2">(</span></span>
<span class="line"><span style="color:#F8F8F2">        ctx,</span></span>
<span class="line"><span style="color:#8BE9FD;font-style:italic">        Character</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#F8F8F2">            alliance,</span></span>
<span class="line"><span style="color:#FF79C6">            ..</span><span style="color:#F8F8F2">character</span></span>
<span class="line"><span style="color:#F8F8F2">        },</span></span>
<span class="line"><span style="color:#F8F8F2">    );</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<p>But that will fail, since SpacetimeDB doesn&#x27;t know how to update our existing <code>character</code> rows with the new column:</p>
<div class="language-text codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_p1l2"><pre tabindex="0" class="prism-code language-text codeBlock_qbrE thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Error: Database update rejected: Errors occurred:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Adding a column alliance to table character requires a manual migration</span><br></span></code></pre></div></div>
<p>Instead, we&#x27;ll add a new table, <code>character_v2</code>, which will coexist with our original <code>character</code> table:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#F8F8F2">#[spacetimedb</span><span style="color:#FF79C6">::</span><span style="color:#F8F8F2">table(name </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> character_v2, public)]</span></span>
<span class="line"><span style="color:#FF79C6">struct</span><span style="color:#8BE9FD;font-style:italic"> CharacterV2</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#F8F8F2">    #[primary_key]</span></span>
<span class="line"><span style="color:#F8F8F2">    player_id</span><span style="color:#FF79C6">:</span><span style="color:#8BE9FD;font-style:italic"> Identity</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">    nickname</span><span style="color:#FF79C6">:</span><span style="color:#8BE9FD;font-style:italic"> String</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">    level</span><span style="color:#FF79C6">:</span><span style="color:#8BE9FD;font-style:italic"> u32</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">    class</span><span style="color:#FF79C6">:</span><span style="color:#8BE9FD;font-style:italic"> Class</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">    alliance</span><span style="color:#FF79C6">:</span><span style="color:#8BE9FD;font-style:italic"> Alliance</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<p>When a new player creates a character, we&#x27;ll make rows in both tables for them. This way, any old clients that are still subscribing to the original <code>character</code> table will continue to work, though of course they won&#x27;t know about the character&#x27;s alliance.</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#F8F8F2">#[spacetimedb</span><span style="color:#FF79C6">::</span><span style="color:#F8F8F2">reducer]</span></span>
<span class="line"><span style="color:#FF79C6">fn</span><span style="color:#50FA7B"> create_character</span><span style="color:#F8F8F2">(ctx</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">ReducerContext</span><span style="color:#F8F8F2">, class</span><span style="color:#FF79C6">:</span><span style="color:#8BE9FD;font-style:italic"> Class</span><span style="color:#F8F8F2">, nickname</span><span style="color:#FF79C6">:</span><span style="color:#8BE9FD;font-style:italic"> String</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#F8F8F2">    log</span><span style="color:#FF79C6">::</span><span style="color:#50FA7B">info!</span><span style="color:#F8F8F2">(</span></span>
<span class="line"><span style="color:#F1FA8C">        &quot;Creating new level 1 {class:?} named {nickname} for player {}&quot;</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">        ctx</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">sender,</span></span>
<span class="line"><span style="color:#F8F8F2">    );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">    ctx</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">db</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">character</span><span style="color:#F8F8F2">()</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">insert</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD;font-style:italic">Character</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#F8F8F2">        player_id</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> ctx</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">sender,</span></span>
<span class="line"><span style="color:#F8F8F2">        nickname</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> nickname</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">clone</span><span style="color:#F8F8F2">(),</span></span>
<span class="line"><span style="color:#F8F8F2">        level</span><span style="color:#FF79C6">:</span><span style="color:#BD93F9"> 1</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">        class,</span></span>
<span class="line"><span style="color:#F8F8F2">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">    ctx</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">db</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">character_v2</span><span style="color:#F8F8F2">()</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">insert</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD;font-style:italic">CharacterV2</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#F8F8F2">        player_id</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> ctx</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">sender,</span></span>
<span class="line"><span style="color:#F8F8F2">        nickname,</span></span>
<span class="line"><span style="color:#F8F8F2">        level</span><span style="color:#FF79C6">:</span><span style="color:#BD93F9"> 1</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">        class,</span></span>
<span class="line"><span style="color:#F8F8F2">        alliance</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> Alliance</span><span style="color:#FF79C6">::</span><span style="color:#8BE9FD;font-style:italic">Neutral</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">    });</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<p>We&#x27;ll update our helper functions so that they operate on <code>character_v2</code> rows. In <code>find_character_for_player</code>, if we don&#x27;t see the player&#x27;s row in <code>character_v2</code>, we&#x27;ll migrate it from <code>character</code> on the fly. In this case, we&#x27;ll make the player neutral, since they haven&#x27;t chosen an alliance yet.</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#FF79C6">fn</span><span style="color:#50FA7B"> find_character_for_player</span><span style="color:#F8F8F2">(ctx</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">ReducerContext</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">-&gt;</span><span style="color:#8BE9FD;font-style:italic"> CharacterV2</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">    if</span><span style="color:#FF79C6"> let</span><span style="color:#8BE9FD;font-style:italic"> Some</span><span style="color:#F8F8F2">(character) </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> ctx</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">db</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">character_v2</span><span style="color:#F8F8F2">()</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">player_id</span><span style="color:#F8F8F2">()</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">find</span><span style="color:#F8F8F2">(ctx</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">sender) {</span></span>
<span class="line"><span style="color:#6272A4">        // Already migrated; just return the new player.</span></span>
<span class="line"><span style="color:#FF79C6">        return</span><span style="color:#F8F8F2"> character;</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">    // Not yet migrated; look up an old character and update it.</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> old_character </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> ctx</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#F8F8F2">db</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">character</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">player_id</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">find</span><span style="color:#F8F8F2">(ctx</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">sender)</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">expect</span><span style="color:#F8F8F2">(</span><span style="color:#F1FA8C">&quot;Player has not created a character&quot;</span><span style="color:#F8F8F2">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">    ctx</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">db</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">character_v2</span><span style="color:#F8F8F2">()</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">insert</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD;font-style:italic">CharacterV2</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#F8F8F2">        player_id</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> old_character</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">player_id,</span></span>
<span class="line"><span style="color:#F8F8F2">        nickname</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> old_character</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">nickname,</span></span>
<span class="line"><span style="color:#F8F8F2">        level</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> old_character</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">level,</span></span>
<span class="line"><span style="color:#F8F8F2">        class</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> old_character</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">class,</span></span>
<span class="line"><span style="color:#F8F8F2">        alliance</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> Alliance</span><span style="color:#FF79C6">::</span><span style="color:#8BE9FD;font-style:italic">Neutral</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">    })</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<p>Just like when creating a new character, when we update a <code>character_v2</code> row, we&#x27;ll also update the old <code>character</code> row, so that outdated clients can continue to function. It&#x27;s very important that we perform the same translation between <code>character</code> and <code>character_v2</code> rows here as in <code>create_character</code> and <code>find_character_for_player</code>.</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#FF79C6">fn</span><span style="color:#50FA7B"> update_character</span><span style="color:#F8F8F2">(ctx</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">ReducerContext</span><span style="color:#F8F8F2">, character</span><span style="color:#FF79C6">:</span><span style="color:#8BE9FD;font-style:italic"> CharacterV2</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#F8F8F2">    ctx</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">db</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">character</span><span style="color:#F8F8F2">()</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">player_id</span><span style="color:#F8F8F2">()</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">update</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD;font-style:italic">Character</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#F8F8F2">        player_id</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> character</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">player_id,</span></span>
<span class="line"><span style="color:#F8F8F2">        nickname</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> character</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">nickname</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">clone</span><span style="color:#F8F8F2">(),</span></span>
<span class="line"><span style="color:#F8F8F2">        level</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> character</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">level,</span></span>
<span class="line"><span style="color:#F8F8F2">        class</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> character</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">class,</span></span>
<span class="line"><span style="color:#F8F8F2">    });</span></span>
<span class="line"><span style="color:#F8F8F2">    ctx</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">db</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">character_v2</span><span style="color:#F8F8F2">()</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">player_id</span><span style="color:#F8F8F2">()</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">update</span><span style="color:#F8F8F2">(character);</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<p>Then we can make trivial modifications to the callers of <code>update_character</code> so that they pass in <code>CharacterV2</code> instances:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#F8F8F2">#[spacetimedb</span><span style="color:#FF79C6">::</span><span style="color:#F8F8F2">reducer]</span></span>
<span class="line"><span style="color:#FF79C6">fn</span><span style="color:#50FA7B"> rename_character</span><span style="color:#F8F8F2">(ctx</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">ReducerContext</span><span style="color:#F8F8F2">, new_name</span><span style="color:#FF79C6">:</span><span style="color:#8BE9FD;font-style:italic"> String</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> character </span><span style="color:#FF79C6">=</span><span style="color:#50FA7B"> find_character_for_player</span><span style="color:#F8F8F2">(ctx);</span></span>
<span class="line"><span style="color:#F8F8F2">    log</span><span style="color:#FF79C6">::</span><span style="color:#50FA7B">info!</span><span style="color:#F8F8F2">(</span></span>
<span class="line"><span style="color:#F1FA8C">        &quot;Renaming {} to {}&quot;</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">        character</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">nickname,</span></span>
<span class="line"><span style="color:#F8F8F2">        new_name,</span></span>
<span class="line"><span style="color:#F8F8F2">    );</span></span>
<span class="line"><span style="color:#50FA7B">    update_character</span><span style="color:#F8F8F2">(</span></span>
<span class="line"><span style="color:#F8F8F2">        ctx,</span></span>
<span class="line"><span style="color:#8BE9FD;font-style:italic">        CharacterV2</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#F8F8F2">            nickname</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> new_name,</span></span>
<span class="line"><span style="color:#FF79C6">            ..</span><span style="color:#F8F8F2">character</span></span>
<span class="line"><span style="color:#F8F8F2">        },</span></span>
<span class="line"><span style="color:#F8F8F2">    );</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">#[spacetimedb</span><span style="color:#FF79C6">::</span><span style="color:#F8F8F2">reducer]</span></span>
<span class="line"><span style="color:#FF79C6">fn</span><span style="color:#50FA7B"> level_up_character</span><span style="color:#F8F8F2">(ctx</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">ReducerContext</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> character </span><span style="color:#FF79C6">=</span><span style="color:#50FA7B"> find_character_for_player</span><span style="color:#F8F8F2">(ctx);</span></span>
<span class="line"><span style="color:#F8F8F2">    log</span><span style="color:#FF79C6">::</span><span style="color:#50FA7B">info!</span><span style="color:#F8F8F2">(</span></span>
<span class="line"><span style="color:#F1FA8C">        &quot;Leveling up {} from {} to {}&quot;</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">        character</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">nickname,</span></span>
<span class="line"><span style="color:#F8F8F2">        character</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">level,</span></span>
<span class="line"><span style="color:#F8F8F2">        character</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">level </span><span style="color:#FF79C6">+</span><span style="color:#BD93F9"> 1</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">    );</span></span>
<span class="line"><span style="color:#50FA7B">    update_character</span><span style="color:#F8F8F2">(</span></span>
<span class="line"><span style="color:#F8F8F2">        ctx,</span></span>
<span class="line"><span style="color:#8BE9FD;font-style:italic">        CharacterV2</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#F8F8F2">            level</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> character</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">level </span><span style="color:#FF79C6">+</span><span style="color:#BD93F9"> 1</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#FF79C6">            ..</span><span style="color:#F8F8F2">character</span></span>
<span class="line"><span style="color:#F8F8F2">        },</span></span>
<span class="line"><span style="color:#F8F8F2">    );</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<p>And finally, we can define our new <code>choose_alliance</code> reducer:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#F8F8F2">#[spacetimedb</span><span style="color:#FF79C6">::</span><span style="color:#F8F8F2">reducer]</span></span>
<span class="line"><span style="color:#FF79C6">fn</span><span style="color:#50FA7B"> choose_alliance</span><span style="color:#F8F8F2">(ctx</span><span style="color:#FF79C6">:</span><span style="color:#FF79C6"> &amp;</span><span style="color:#8BE9FD;font-style:italic">ReducerContext</span><span style="color:#F8F8F2">, alliance</span><span style="color:#FF79C6">:</span><span style="color:#8BE9FD;font-style:italic"> Alliance</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> character </span><span style="color:#FF79C6">=</span><span style="color:#50FA7B"> find_character_for_player</span><span style="color:#F8F8F2">(ctx);</span></span>
<span class="line"><span style="color:#F8F8F2">    log</span><span style="color:#FF79C6">::</span><span style="color:#50FA7B">info!</span><span style="color:#F8F8F2">(</span></span>
<span class="line"><span style="color:#F1FA8C">        &quot;Setting alliance of {} to {:?}&quot;</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">        character</span><span style="color:#FF79C6">.</span><span style="color:#F8F8F2">nickname,</span></span>
<span class="line"><span style="color:#F8F8F2">        alliance,</span></span>
<span class="line"><span style="color:#F8F8F2">    );</span></span>
<span class="line"><span style="color:#50FA7B">    update_character</span><span style="color:#F8F8F2">(</span></span>
<span class="line"><span style="color:#F8F8F2">        ctx,</span></span>
<span class="line"><span style="color:#8BE9FD;font-style:italic">        CharacterV2</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#F8F8F2">            alliance,</span></span>
<span class="line"><span style="color:#FF79C6">            ..</span><span style="color:#F8F8F2">character</span></span>
<span class="line"><span style="color:#F8F8F2">        },</span></span>
<span class="line"><span style="color:#F8F8F2">    );</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<p>A bit more playing around with the CLI will show us that everything works as intended:</p>
<pre tabindex="0" class="codeBlockStandalone_pMzE thin-scrollbar codeBlockContainer_HZVP theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_ckKi"><span class="line"><span style="color:#6272A4"># Our row in `character` still exists:</span></span>
<span class="line"><span style="color:#50FA7B">$</span><span style="color:#F1FA8C"> spacetime</span><span style="color:#F1FA8C"> sql</span><span style="color:#F1FA8C"> incr-migration-demo</span><span style="color:#E9F284"> &#x27;</span><span style="color:#F1FA8C">SELECT * FROM character</span><span style="color:#E9F284">&#x27;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#50FA7B"> player_id</span><span style="color:#FF79C6"> |</span><span style="color:#50FA7B"> nickname</span><span style="color:#FF79C6"> |</span><span style="color:#50FA7B"> level</span><span style="color:#FF79C6"> |</span><span style="color:#50FA7B"> class</span></span>
<span class="line"><span style="color:#50FA7B">-----------+----------+-------+----------------</span></span>
<span class="line"><span style="color:#FF79C6"> &lt;</span><span style="color:#50FA7B">snip</span><span style="color:#F8F8F2">&gt;    </span><span style="color:#FF79C6">|</span><span style="color:#50FA7B"> &quot;Gefjon&quot;</span><span style="color:#FF79C6"> |</span><span style="color:#50FA7B"> 2</span><span style="color:#FF79C6">     |</span><span style="color:#F8F8F2"> (</span><span style="color:#50FA7B">Fighter</span><span style="color:#F1FA8C"> =</span><span style="color:#F8F8F2"> ())</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4"># We haven&#x27;t triggered the &quot;Gefjon&quot; row to migrate yet, so `character_v2` is empty:</span></span>
<span class="line"><span style="color:#50FA7B">$</span><span style="color:#F1FA8C"> spacetime</span><span style="color:#F1FA8C"> sql</span><span style="color:#BD93F9"> -s</span><span style="color:#F1FA8C"> local</span><span style="color:#F1FA8C"> incr-migration-demo</span><span style="color:#E9F284"> &#x27;</span><span style="color:#F1FA8C">SELECT * FROM character_v2</span><span style="color:#E9F284">&#x27;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#50FA7B"> player_id</span><span style="color:#FF79C6"> |</span><span style="color:#50FA7B"> nickname</span><span style="color:#FF79C6"> |</span><span style="color:#50FA7B"> level</span><span style="color:#FF79C6"> |</span><span style="color:#50FA7B"> class</span><span style="color:#FF79C6"> |</span><span style="color:#50FA7B"> alliance</span></span>
<span class="line"><span style="color:#50FA7B">-----------+----------+-------+-------+----------</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4"># Accessing our character, e.g. by leveling up, will cause it to migrate into `character_v2`:</span></span>
<span class="line"><span style="color:#50FA7B">$</span><span style="color:#F1FA8C"> spacetime</span><span style="color:#F1FA8C"> call</span><span style="color:#F1FA8C"> incr-migration-demo</span><span style="color:#F1FA8C"> level_up_character</span></span>
<span class="line"></span>
<span class="line"><span style="color:#50FA7B">2025-01-07T16:00:20.500600Z</span><span style="color:#F1FA8C">  INFO:</span><span style="color:#F1FA8C"> src/lib.rs:110:</span><span style="color:#F1FA8C"> Leveling</span><span style="color:#F1FA8C"> up</span><span style="color:#F1FA8C"> Gefjon</span><span style="color:#F1FA8C"> from</span><span style="color:#BD93F9"> 2</span><span style="color:#F1FA8C"> to</span><span style="color:#BD93F9"> 3</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4"># Now `character_v2` is populated:</span></span>
<span class="line"><span style="color:#50FA7B">$</span><span style="color:#F1FA8C"> spacetime</span><span style="color:#F1FA8C"> sql</span><span style="color:#F1FA8C"> incr-migration-demo</span><span style="color:#E9F284"> &#x27;</span><span style="color:#F1FA8C">SELECT * FROM character_v2</span><span style="color:#E9F284">&#x27;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#50FA7B"> player_id</span><span style="color:#FF79C6"> |</span><span style="color:#50FA7B"> nickname</span><span style="color:#FF79C6"> |</span><span style="color:#50FA7B"> level</span><span style="color:#FF79C6"> |</span><span style="color:#50FA7B"> class</span><span style="color:#FF79C6">          |</span><span style="color:#50FA7B"> alliance</span></span>
<span class="line"><span style="color:#50FA7B">-----------+----------+-------+----------------+----------------</span></span>
<span class="line"><span style="color:#FF79C6"> &lt;</span><span style="color:#50FA7B">snip</span><span style="color:#F8F8F2">&gt;    </span><span style="color:#FF79C6">|</span><span style="color:#50FA7B"> &quot;Gefjon&quot;</span><span style="color:#FF79C6"> |</span><span style="color:#50FA7B"> 3</span><span style="color:#FF79C6">     |</span><span style="color:#F8F8F2"> (</span><span style="color:#50FA7B">Fighter</span><span style="color:#F1FA8C"> =</span><span style="color:#F8F8F2"> ()) </span><span style="color:#FF79C6">|</span><span style="color:#F8F8F2"> (</span><span style="color:#50FA7B">Neutral</span><span style="color:#F1FA8C"> =</span><span style="color:#F8F8F2"> ())</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4"># The original row in `character` still got updated by `level_up_character`,</span></span>
<span class="line"><span style="color:#6272A4"># so outdated clients can continue to function:</span></span>
<span class="line"><span style="color:#50FA7B">$</span><span style="color:#F1FA8C"> spacetime</span><span style="color:#F1FA8C"> sql</span><span style="color:#F1FA8C"> incr-migration-demo</span><span style="color:#E9F284"> &#x27;</span><span style="color:#F1FA8C">SELECT * FROM character</span><span style="color:#E9F284">&#x27;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#50FA7B"> player_id</span><span style="color:#FF79C6"> |</span><span style="color:#50FA7B"> nickname</span><span style="color:#FF79C6"> |</span><span style="color:#50FA7B"> level</span><span style="color:#FF79C6"> |</span><span style="color:#50FA7B"> class</span></span>
<span class="line"><span style="color:#50FA7B">-----------+----------+-------+----------------</span></span>
<span class="line"><span style="color:#FF79C6"> &lt;</span><span style="color:#50FA7B">snip</span><span style="color:#F8F8F2">&gt;    </span><span style="color:#FF79C6">|</span><span style="color:#50FA7B"> &quot;Gefjon&quot;</span><span style="color:#FF79C6"> |</span><span style="color:#50FA7B"> 3</span><span style="color:#FF79C6">     |</span><span style="color:#F8F8F2"> (</span><span style="color:#50FA7B">Fighter</span><span style="color:#F1FA8C"> =</span><span style="color:#F8F8F2"> ())</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4"># We can set our alliance:</span></span>
<span class="line"><span style="color:#50FA7B">$</span><span style="color:#F1FA8C"> spacetime</span><span style="color:#F1FA8C"> call</span><span style="color:#F1FA8C"> incr-migration-demo</span><span style="color:#F1FA8C"> choose_alliance</span><span style="color:#E9F284"> &#x27;</span><span style="color:#F1FA8C">{ &quot;Good&quot;: {} }</span><span style="color:#E9F284">&#x27;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#50FA7B">2025-01-07T16:13:53.816501Z</span><span style="color:#F1FA8C">  INFO:</span><span style="color:#F1FA8C"> src/lib.rs:129:</span><span style="color:#F1FA8C"> Setting</span><span style="color:#F1FA8C"> alliance</span><span style="color:#F1FA8C"> of</span><span style="color:#F1FA8C"> Gefjon</span><span style="color:#F1FA8C"> to</span><span style="color:#F1FA8C"> Good</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4"># And that change shows up in `character_v2`:</span></span>
<span class="line"><span style="color:#50FA7B">$</span><span style="color:#F1FA8C"> spacetime</span><span style="color:#F1FA8C"> sql</span><span style="color:#F1FA8C"> incr-migration-demo</span><span style="color:#E9F284"> &#x27;</span><span style="color:#F1FA8C">SELECT * FROM character_v2</span><span style="color:#E9F284">&#x27;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#50FA7B"> player_id</span><span style="color:#FF79C6"> |</span><span style="color:#50FA7B"> nickname</span><span style="color:#FF79C6"> |</span><span style="color:#50FA7B"> level</span><span style="color:#FF79C6"> |</span><span style="color:#50FA7B"> class</span><span style="color:#FF79C6">          |</span><span style="color:#50FA7B"> alliance</span></span>
<span class="line"><span style="color:#50FA7B">-----------+----------+-------+----------------+-------------</span></span>
<span class="line"><span style="color:#FF79C6"> &lt;</span><span style="color:#50FA7B">snip</span><span style="color:#F8F8F2">&gt;    </span><span style="color:#FF79C6">|</span><span style="color:#50FA7B"> &quot;Gefjon&quot;</span><span style="color:#FF79C6"> |</span><span style="color:#50FA7B"> 3</span><span style="color:#FF79C6">     |</span><span style="color:#F8F8F2"> (</span><span style="color:#50FA7B">Fighter</span><span style="color:#F1FA8C"> =</span><span style="color:#F8F8F2"> ()) </span><span style="color:#FF79C6">|</span><span style="color:#F8F8F2"> (</span><span style="color:#50FA7B">Good</span><span style="color:#F1FA8C"> =</span><span style="color:#F8F8F2"> ())</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4"># But `character` is not changed, since it doesn&#x27;t know about alliances:</span></span>
<span class="line"><span style="color:#50FA7B">$</span><span style="color:#F1FA8C"> spacetime</span><span style="color:#F1FA8C"> sql</span><span style="color:#F1FA8C"> incr-migration-demo</span><span style="color:#E9F284"> &#x27;</span><span style="color:#F1FA8C">SELECT * FROM character</span><span style="color:#E9F284">&#x27;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#50FA7B"> player_id</span><span style="color:#FF79C6"> |</span><span style="color:#50FA7B"> nickname</span><span style="color:#FF79C6"> |</span><span style="color:#50FA7B"> level</span><span style="color:#FF79C6"> |</span><span style="color:#50FA7B"> class</span></span>
<span class="line"><span style="color:#50FA7B">-----------+----------+-------+----------------</span></span>
<span class="line"><span style="color:#FF79C6"> &lt;</span><span style="color:#50FA7B">snip</span><span style="color:#F8F8F2">&gt;    </span><span style="color:#FF79C6">|</span><span style="color:#50FA7B"> &quot;Gefjon&quot;</span><span style="color:#FF79C6"> |</span><span style="color:#50FA7B"> 3</span><span style="color:#FF79C6">     |</span><span style="color:#F8F8F2"> (</span><span style="color:#50FA7B">Fighter</span><span style="color:#F1FA8C"> =</span><span style="color:#F8F8F2"> ())</span></span></code></pre>
<p>Now that we know how to define incremental migrations, we can add new features that would seem to require breaking schema changes without cumbersome external migration tools and while maintaining compatibility of outdated clients! The complete for this tutorial is on GitHub in the <code>clockworklabs/incr-migration-demo</code> repository, in branches <a href="https://github.com/clockworklabs/incr-migration-demo/tree/v1" target="_blank" rel="noopener noreferrer"><code>v1</code></a>, <a href="https://github.com/clockworklabs/incr-migration-demo/tree/fails-publish" target="_blank" rel="noopener noreferrer"><code>fails-publish</code></a> and <a href="https://github.com/clockworklabs/incr-migration-demo/tree/v2" target="_blank" rel="noopener noreferrer"><code>v2</code></a>.</p></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/rls"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Row Level Security</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/how-to/reject-client-connections"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Reject Client Connections</div></a></nav></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer"><div class="container container-fluid"></div></footer></div>
</body>
</html>