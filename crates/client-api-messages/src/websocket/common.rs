use spacetimedb_sats::{de::Error, impl_deserialize, impl_serialize, impl_st, AlgebraicType, SpacetimeType};

/// An opaque id generated by the client to refer to a subscription.
/// This is used in Unsubscribe messages and errors.
#[derive(SpacetimeType, Copy, Clone, Debug, PartialEq, Eq, Hash)]
#[sats(crate = spacetimedb_lib)]
pub struct QuerySetId {
    pub id: u32,
}

impl QuerySetId {
    pub fn new(id: u32) -> Self {
        Self { id }
    }
}

#[derive(Clone, Copy, Default, PartialEq, Eq)]
pub enum CallReducerFlags {
    /// The reducer's caller does want to be notified about the reducer completing successfully
    /// regardless of whether the caller had subscribed to a relevant query.
    ///
    /// Note that updates to a reducer's caller are always sent as full updates
    /// whether subscribed to a relevant query or not.
    /// That is, the light tx mode setting does not apply to the reducer's caller.
    ///
    /// This is the default flag.
    #[default]
    FullUpdate,
    /// The reducer's caller does not want to be notified about the reducer completing successfully
    /// without having subscribed to any of the relevant queries.
    NoSuccessNotify,
}

impl_st!([] CallReducerFlags, AlgebraicType::U8);
impl_serialize!([] CallReducerFlags, (self, ser) => ser.serialize_u8(*self as u8));
impl_deserialize!([] CallReducerFlags, de => match de.deserialize_u8()? {
    0 => Ok(Self::FullUpdate),
    1 => Ok(Self::NoSuccessNotify),
    x => Err(D::Error::custom(format_args!("invalid call reducer flag {x}"))),
});

#[derive(Clone, Copy, Default, PartialEq, Eq)]
pub enum CallProcedureFlags {
    #[default]
    Default,
}

impl_st!([] CallProcedureFlags, AlgebraicType::U8);
impl_serialize!([] CallProcedureFlags, (self, ser) => ser.serialize_u8(*self as u8));
impl_deserialize!([] CallProcedureFlags, de => match de.deserialize_u8()? {
    0 => Ok(Self::Default),
    x => Err(D::Error::custom(format_args!("invalid call procedure flag {x}"))),
});
